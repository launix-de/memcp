metadata:
  version: "1.0"
  description: "Date type and date functions: tagDate, DATE column, DATE literal, INTERVAL, EXTRACT, DATE_ADD, DATE_SUB, CURRENT_DATE"

test_cases:
  # --- Setup ---
  - name: "Create table with DATE column"
    sql: "CREATE TABLE date_test (id INT PRIMARY KEY, dt DATE, ts DATETIME)"

  # --- INSERT datetime string ---
  - name: "Insert datetime string"
    sql: "INSERT INTO date_test (id, dt, ts) VALUES (1, '2024-06-15 10:30:00', '2024-06-15 10:30:00')"

  - name: "Select datetime string"
    sql: "SELECT dt, ts FROM date_test WHERE id = 1"
    expect:
      rows: 1
      data:
        - dt: "2024-06-15 10:30:00"
          ts: "2024-06-15 10:30:00"

  # --- INSERT unix timestamp integer ---
  - name: "Insert unix timestamp"
    sql: "INSERT INTO date_test (id, dt, ts) VALUES (2, 1704067200, 1704067200)"

  - name: "Select unix timestamp as datetime"
    sql: "SELECT dt FROM date_test WHERE id = 2"
    expect:
      rows: 1
      data:
        - dt: "2024-01-01 00:00:00"

  # --- INSERT date-only string ---
  - name: "Insert date-only string"
    sql: "INSERT INTO date_test (id, dt) VALUES (3, '2024-12-25')"

  - name: "Select date-only string"
    sql: "SELECT dt FROM date_test WHERE id = 3"
    expect:
      rows: 1
      data:
        - dt: "2024-12-25 00:00:00"

  # --- NULL in DATE column ---
  - name: "Insert NULL date"
    sql: "INSERT INTO date_test (id, dt) VALUES (4, NULL)"

  - name: "Select NULL date"
    sql: "SELECT dt FROM date_test WHERE id = 4"
    expect:
      rows: 1
      data:
        - dt: null

  # --- NOW() stored in DATE column ---
  - name: "Insert NOW() into date column"
    sql: "INSERT INTO date_test (id, dt) VALUES (5, NOW())"

  - name: "NOW() value is not null"
    sql: "SELECT dt IS NOT NULL AS ok FROM date_test WHERE id = 5"
    expect:
      rows: 1
      data:
        - ok: 1

  # --- DATE_FORMAT on DATE column ---
  - name: "DATE_FORMAT on date column"
    sql: "SELECT DATE_FORMAT(dt, '%Y-%m-%d') AS d FROM date_test WHERE id = 1"
    expect:
      rows: 1
      data:
        - d: "2024-06-15"

  # --- Comparison: WHERE date_col > string ---
  - name: "Date greater than string"
    sql: "SELECT id FROM date_test WHERE dt > '2024-06-01' AND dt < '2025-01-01' ORDER BY id"
    expect:
      rows: 2
      data:
        - id: 1
        - id: 3

  # --- Comparison: WHERE date_col BETWEEN strings ---
  - name: "Date BETWEEN strings"
    sql: "SELECT id FROM date_test WHERE dt BETWEEN '2024-01-01' AND '2024-12-31' ORDER BY id"
    expect:
      rows: 3
      data:
        - id: 1
        - id: 2
        - id: 3

  # --- FROM_UNIXTIME ---
  - name: "FROM_UNIXTIME returns datetime string"
    sql: "SELECT FROM_UNIXTIME(0) AS r"
    expect:
      rows: 1
      data:
        - r: "1970-01-01 00:00:00"

  # --- DATE literal ---
  - name: "DATE literal"
    sql: "SELECT DATE '2024-03-15' AS d"
    expect:
      rows: 1
      data:
        - d: "2024-03-15 00:00:00"

  # --- DATE literal in comparison ---
  - name: "DATE literal comparison"
    sql: "SELECT id FROM date_test WHERE dt > DATE '2024-06-01' AND dt < DATE '2025-01-01' ORDER BY id"
    expect:
      rows: 2
      data:
        - id: 1
        - id: 3

  # --- EXTRACT ---
  - name: "EXTRACT YEAR"
    sql: "SELECT EXTRACT(YEAR FROM dt) AS y FROM date_test WHERE id = 1"
    expect:
      rows: 1
      data:
        - y: 2024

  - name: "EXTRACT MONTH"
    sql: "SELECT EXTRACT(MONTH FROM dt) AS m FROM date_test WHERE id = 1"
    expect:
      rows: 1
      data:
        - m: 6

  - name: "EXTRACT DAY"
    sql: "SELECT EXTRACT(DAY FROM dt) AS d FROM date_test WHERE id = 1"
    expect:
      rows: 1
      data:
        - d: 15

  # --- DATE_ADD ---
  - name: "DATE_ADD days"
    sql: "SELECT DATE_ADD(DATE '2024-01-01', INTERVAL 10 DAY) AS d"
    expect:
      rows: 1
      data:
        - d: "2024-01-11 00:00:00"

  - name: "DATE_ADD months"
    sql: "SELECT DATE_ADD(DATE '2024-01-15', INTERVAL 3 MONTH) AS d"
    expect:
      rows: 1
      data:
        - d: "2024-04-15 00:00:00"

  - name: "DATE_ADD years"
    sql: "SELECT DATE_ADD(DATE '2024-03-15', INTERVAL 1 YEAR) AS d"
    expect:
      rows: 1
      data:
        - d: "2025-03-15 00:00:00"

  # --- DATE_SUB ---
  - name: "DATE_SUB days"
    sql: "SELECT DATE_SUB(DATE '2024-06-15', INTERVAL 15 DAY) AS d"
    expect:
      rows: 1
      data:
        - d: "2024-05-31 00:00:00"

  # --- INTERVAL arithmetic: date + interval ---
  - name: "Date plus interval"
    sql: "SELECT DATE '2024-01-01' + INTERVAL 90 DAY AS d"
    expect:
      rows: 1
      data:
        - d: "2024-03-31 00:00:00"

  - name: "Date minus interval"
    sql: "SELECT DATE '1998-12-01' - INTERVAL 90 DAY AS d"
    expect:
      rows: 1
      data:
        - d: "1998-09-02 00:00:00"

  - name: "Date plus interval year"
    sql: "SELECT DATE '1995-03-15' + INTERVAL 1 YEAR AS d"
    expect:
      rows: 1
      data:
        - d: "1996-03-15 00:00:00"

  # --- CURRENT_DATE ---
  - name: "CURRENT_DATE is not null"
    sql: "SELECT CURRENT_DATE IS NOT NULL AS ok"
    expect:
      rows: 1
      data:
        - ok: 1

  # --- DATE() function ---
  - name: "DATE function truncates to midnight"
    sql: "SELECT DATE('2024-06-15 10:30:00') AS d"
    expect:
      rows: 1
      data:
        - d: "2024-06-15 00:00:00"

  # --- DATEDIFF ---
  - name: "DATEDIFF positive"
    sql: "SELECT DATEDIFF('2025-06-15', '2025-06-10') AS d"
    expect:
      rows: 1
      data:
        - d: 5

  - name: "DATEDIFF negative"
    sql: "SELECT DATEDIFF('2025-06-10', '2025-06-15') AS d"
    expect:
      rows: 1
      data:
        - d: -5

  - name: "DATEDIFF same day different times"
    sql: "SELECT DATEDIFF('2025-06-15 23:59:59', '2025-06-15 00:00:00') AS d"
    expect:
      rows: 1
      data:
        - d: 0

  - name: "DATEDIFF with NULL"
    sql: "SELECT DATEDIFF(NULL, '2025-06-15') AS d"
    expect:
      rows: 1
      data:
        - d: null

  # --- DATE_FORMAT additional specifiers ---
  - name: "DATE_FORMAT %T time shorthand"
    sql: "SELECT DATE_FORMAT('2024-06-15 14:30:45', '%T') AS t"
    expect:
      rows: 1
      data:
        - t: "14:30:45"

  - name: "DATE_FORMAT unknown specifier passthrough"
    sql: "SELECT DATE_FORMAT('2024-06-15', '%Y-%q') AS d"
    expect:
      rows: 1
      data:
        - d: "2024-%q"

  # --- DATE_SUB additional units ---
  - name: "DATE_SUB months"
    sql: "SELECT DATE_SUB(DATE '2024-06-15', INTERVAL 2 MONTH) AS d"
    expect:
      rows: 1
      data:
        - d: "2024-04-15 00:00:00"

  - name: "DATE_SUB years"
    sql: "SELECT DATE_SUB(DATE '2024-06-15', INTERVAL 1 YEAR) AS d"
    expect:
      rows: 1
      data:
        - d: "2023-06-15 00:00:00"

  - name: "DATE_SUB hours"
    sql: "SELECT DATE_SUB('2024-06-15 14:30:00', INTERVAL 2 HOUR) AS d"
    expect:
      rows: 1
      data:
        - d: "2024-06-15 12:30:00"

  - name: "DATE_SUB minutes"
    sql: "SELECT DATE_SUB('2024-06-15 14:30:00', INTERVAL 15 MINUTE) AS d"
    expect:
      rows: 1
      data:
        - d: "2024-06-15 14:15:00"

  - name: "DATE_SUB seconds"
    sql: "SELECT DATE_SUB('2024-06-15 14:30:45', INTERVAL 20 SECOND) AS d"
    expect:
      rows: 1
      data:
        - d: "2024-06-15 14:30:25"

  - name: "DATE_SUB weeks"
    sql: "SELECT DATE_SUB(DATE '2024-06-15', INTERVAL 1 WEEK) AS d"
    expect:
      rows: 1
      data:
        - d: "2024-06-08 00:00:00"

  # --- DATE_ADD additional units ---
  - name: "DATE_ADD hours"
    sql: "SELECT DATE_ADD('2024-06-15 10:00:00', INTERVAL 3 HOUR) AS d"
    expect:
      rows: 1
      data:
        - d: "2024-06-15 13:00:00"

  - name: "DATE_ADD minutes"
    sql: "SELECT DATE_ADD('2024-06-15 10:00:00', INTERVAL 45 MINUTE) AS d"
    expect:
      rows: 1
      data:
        - d: "2024-06-15 10:45:00"

  - name: "DATE_ADD seconds"
    sql: "SELECT DATE_ADD('2024-06-15 10:00:00', INTERVAL 30 SECOND) AS d"
    expect:
      rows: 1
      data:
        - d: "2024-06-15 10:00:30"

  - name: "DATE_ADD weeks"
    sql: "SELECT DATE_ADD(DATE '2024-06-15', INTERVAL 2 WEEK) AS d"
    expect:
      rows: 1
      data:
        - d: "2024-06-29 00:00:00"

  # --- EXTRACT additional fields ---
  - name: "EXTRACT HOUR"
    sql: "SELECT EXTRACT(HOUR FROM '2024-06-15 14:30:45') AS h"
    expect:
      rows: 1
      data:
        - h: 14

  - name: "EXTRACT MINUTE"
    sql: "SELECT EXTRACT(MINUTE FROM '2024-06-15 14:30:45') AS m"
    expect:
      rows: 1
      data:
        - m: 30

  - name: "EXTRACT SECOND"
    sql: "SELECT EXTRACT(SECOND FROM '2024-06-15 14:30:45') AS s"
    expect:
      rows: 1
      data:
        - s: 45

  # --- STR_TO_DATE ---
  - name: "STR_TO_DATE basic"
    sql: "SELECT STR_TO_DATE('15/06/2024', '%d/%m/%Y') AS d"
    expect:
      rows: 1
      data:
        - d: "2024-06-15 00:00:00"

  - name: "STR_TO_DATE with time"
    sql: "SELECT STR_TO_DATE('2024-06-15 14:30:45', '%Y-%m-%d %H:%i:%s') AS d"
    expect:
      rows: 1
      data:
        - d: "2024-06-15 14:30:45"

  - name: "STR_TO_DATE NULL returns NULL"
    sql: "SELECT STR_TO_DATE(NULL, '%Y-%m-%d') AS d"
    expect:
      rows: 1
      data:
        - d: null

  - name: "STR_TO_DATE invalid returns NULL"
    sql: "SELECT STR_TO_DATE('not-a-date', '%Y-%m-%d') AS d"
    expect:
      rows: 1
      data:
        - d: null

  - name: "STR_TO_DATE two-digit year %y"
    sql: "SELECT DATE_FORMAT(STR_TO_DATE('24-06-15', '%y-%m-%d'), '%Y-%m-%d') AS d"
    expect:
      rows: 1
      data:
        - d: "2024-06-15"

  - name: "STR_TO_DATE literal percent %%"
    sql: "SELECT DATE_FORMAT(STR_TO_DATE('2024%06%15', '%Y%%%m%%%d'), '%Y-%m-%d') AS d"
    expect:
      rows: 1
      data:
        - d: "2024-06-15"

  # --- DATEDIFF with invalid strings ---
  - name: "DATEDIFF invalid first arg"
    sql: "SELECT DATEDIFF('not-a-date', '2025-06-15') AS d"
    expect:
      rows: 1
      data:
        - d: null

  - name: "DATEDIFF invalid second arg"
    sql: "SELECT DATEDIFF('2025-06-15', 'garbage') AS d"
    expect:
      rows: 1
      data:
        - d: null

  # --- NULL propagation for date functions ---
  - name: "DATE_ADD NULL date"
    sql: "SELECT DATE_ADD(NULL, INTERVAL 1 DAY) AS d"
    expect:
      rows: 1
      data:
        - d: null

  - name: "DATE_SUB NULL date"
    sql: "SELECT DATE_SUB(NULL, INTERVAL 1 DAY) AS d"
    expect:
      rows: 1
      data:
        - d: null

  - name: "EXTRACT NULL date"
    sql: "SELECT EXTRACT(YEAR FROM NULL) AS y"
    expect:
      rows: 1
      data:
        - y: null

  # --- Window function parse tests (no FROM table = error) ---
  - name: "Window function without FROM table"
    sql: "SELECT LEAD(1) OVER (ORDER BY 1) AS l"
    expect:
      error: true

  - name: "Window function with PARTITION BY without FROM table"
    sql: "SELECT LEAD(1) OVER (PARTITION BY 1 ORDER BY 1 DESC) AS l"
    expect:
      error: true

cleanup:
  - sql: "DROP TABLE IF EXISTS date_test"
