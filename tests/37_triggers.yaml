# Trigger Infrastructure Tests
# Testing SQL CREATE/DROP TRIGGER and basic trigger execution

metadata:
  version: "1.0"
  description: "SQL trigger infrastructure tests"

cleanup:
  - action: "Clean up test tables"
    sql: "DROP TABLE IF EXISTS trigger_test"
  - action: "Clean up log table"
    sql: "DROP TABLE IF EXISTS trigger_log"

setup:
  - action: "Create test table"
    sql: "CREATE TABLE trigger_test (id INT, val INT, name VARCHAR(50))"
  - action: "Create log table for trigger testing"
    sql: "CREATE TABLE trigger_log (id INT, action VARCHAR(20), old_val INT, new_val INT)"

test_cases:
  # Basic table operations should still work
  - name: "Basic INSERT works"
    sql: "INSERT INTO trigger_test (id, val, name) VALUES (1, 100, 'test')"
    expect:
      affected_rows: 1

  - name: "Basic SELECT works"
    sql: "SELECT id, val, name FROM trigger_test WHERE id = 1"
    expect:
      rows: 1
      data:
        - id: 1
          val: 100
          name: "test"

  - name: "Basic UPDATE works"
    sql: "UPDATE trigger_test SET val = 200 WHERE id = 1"
    expect:
      affected_rows: 1

  - name: "Verify UPDATE"
    sql: "SELECT val FROM trigger_test WHERE id = 1"
    expect:
      data:
        - val: 200

  - name: "Basic DELETE works"
    sql: "DELETE FROM trigger_test WHERE id = 1"
    expect:
      affected_rows: 1

  - name: "Verify DELETE"
    sql: "SELECT COUNT(*) as cnt FROM trigger_test"
    expect:
      data:
        - cnt: 0

  # TODO: Add CREATE TRIGGER tests once trigger execution is wired up
  # For now, just test that the syntax is accepted
  # - name: "CREATE TRIGGER syntax accepted"
  #   sql: |
  #     CREATE TRIGGER test_trigger
  #     AFTER INSERT ON trigger_test
  #     FOR EACH ROW
  #     BEGIN
  #       INSERT INTO trigger_log (id, action) VALUES (NEW.id, 'insert');
  #     END
  #   expect:
  #     affected_rows: 0
