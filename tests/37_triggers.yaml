# Trigger Infrastructure Tests
# Testing SQL CREATE/DROP TRIGGER and basic trigger execution

metadata:
  version: "1.0"
  description: "SQL trigger infrastructure tests"

cleanup:
  - action: "Clean up test tables"
    sql: "DROP TABLE IF EXISTS trigger_test"
  - action: "Clean up log table"
    sql: "DROP TABLE IF EXISTS trigger_log"

setup:
  - action: "Create test table"
    sql: "CREATE TABLE trigger_test (id INT, val INT, name VARCHAR(50))"
  - action: "Create log table for trigger testing"
    sql: "CREATE TABLE trigger_log (id INT, action VARCHAR(20), old_val INT, new_val INT)"

test_cases:
  # Basic table operations should still work
  - name: "Basic INSERT works"
    sql: "INSERT INTO trigger_test (id, val, name) VALUES (1, 100, 'test')"
    expect:
      affected_rows: 1

  - name: "Basic SELECT works"
    sql: "SELECT id, val, name FROM trigger_test WHERE id = 1"
    expect:
      rows: 1
      data:
        - id: 1
          val: 100
          name: "test"

  - name: "Basic UPDATE works"
    sql: "UPDATE trigger_test SET val = 200 WHERE id = 1"
    expect:
      affected_rows: 1

  - name: "Verify UPDATE"
    sql: "SELECT val FROM trigger_test WHERE id = 1"
    expect:
      data:
        - val: 200

  - name: "Basic DELETE works"
    sql: "DELETE FROM trigger_test WHERE id = 1"
    expect:
      affected_rows: 1

  - name: "Verify DELETE"
    sql: "SELECT COUNT(*) as cnt FROM trigger_test"
    expect:
      data:
        - cnt: 0

  # BEFORE INSERT trigger tests
  - name: "CREATE BEFORE INSERT trigger"
    sql: "CREATE TRIGGER before_ins_trigger BEFORE INSERT ON trigger_test FOR EACH ROW SET NEW.val = 999"
    expect:
      affected_rows: 0

  - name: "INSERT with BEFORE INSERT trigger - value should be modified"
    sql: "INSERT INTO trigger_test (id, val, name) VALUES (10, 100, 'triggered')"
    expect:
      affected_rows: 1

  - name: "Verify BEFORE INSERT trigger modified the value"
    sql: "SELECT id, val, name FROM trigger_test WHERE id = 10"
    expect:
      rows: 1
      data:
        - id: 10
          val: 999
          name: "triggered"

  - name: "DROP TRIGGER"
    sql: "DROP TRIGGER before_ins_trigger"
    expect:
      affected_rows: 0

  - name: "INSERT after DROP TRIGGER - value should NOT be modified"
    sql: "INSERT INTO trigger_test (id, val, name) VALUES (11, 100, 'no_trigger')"
    expect:
      affected_rows: 1

  - name: "Verify value is NOT modified after trigger dropped"
    sql: "SELECT id, val, name FROM trigger_test WHERE id = 11"
    expect:
      rows: 1
      data:
        - id: 11
          val: 100
          name: "no_trigger"

  # BEFORE INSERT trigger with expression using NEW column
  - name: "CREATE BEFORE INSERT trigger with expression"
    sql: "CREATE TRIGGER calc_trigger BEFORE INSERT ON trigger_test FOR EACH ROW SET NEW.val = NEW.id * 10"
    expect:
      affected_rows: 0

  - name: "INSERT with expression trigger"
    sql: "INSERT INTO trigger_test (id, val, name) VALUES (5, 1, 'calc')"
    expect:
      affected_rows: 1

  - name: "Verify expression trigger calculated value"
    sql: "SELECT id, val, name FROM trigger_test WHERE id = 5"
    expect:
      rows: 1
      data:
        - id: 5
          val: 50
          name: "calc"

  - name: "DROP expression trigger"
    sql: "DROP TRIGGER calc_trigger"
    expect:
      affected_rows: 0

  # DROP TRIGGER IF EXISTS
  - name: "DROP TRIGGER IF EXISTS - non-existent trigger"
    sql: "DROP TRIGGER IF EXISTS nonexistent_trigger"
    expect:
      affected_rows: 0

  # BEFORE UPDATE trigger tests with OLD/NEW comparison
  - name: "Clean up for UPDATE trigger test"
    sql: "DELETE FROM trigger_test"
    expect:
      affected_rows_any: true

  - name: "Insert row for UPDATE trigger test"
    sql: "INSERT INTO trigger_test (id, val, name) VALUES (100, 0, 'counter_test')"
    expect:
      affected_rows: 1

  - name: "CREATE BEFORE UPDATE trigger with OLD reference"
    sql: "CREATE TRIGGER counter_trigger BEFORE UPDATE ON trigger_test FOR EACH ROW SET NEW.val = OLD.val + 1"
    expect:
      affected_rows: 0

  - name: "Verify initial value"
    sql: "SELECT val FROM trigger_test WHERE id = 100"
    expect:
      data:
        - val: 0

  - name: "First UPDATE - trigger should increment counter"
    sql: "UPDATE trigger_test SET name = 'first_update' WHERE id = 100"
    expect:
      affected_rows: 1

  - name: "Verify counter after first UPDATE"
    sql: "SELECT val, name FROM trigger_test WHERE id = 100"
    expect:
      data:
        - val: 1
          name: "first_update"

  - name: "Second UPDATE - trigger should increment counter again"
    sql: "UPDATE trigger_test SET name = 'second_update' WHERE id = 100"
    expect:
      affected_rows: 1

  - name: "Verify counter after second UPDATE"
    sql: "SELECT val, name FROM trigger_test WHERE id = 100"
    expect:
      data:
        - val: 2
          name: "second_update"

  - name: "Third UPDATE - trigger should increment counter again"
    sql: "UPDATE trigger_test SET name = 'third_update' WHERE id = 100"
    expect:
      affected_rows: 1

  - name: "Verify counter after third UPDATE"
    sql: "SELECT val, name FROM trigger_test WHERE id = 100"
    expect:
      data:
        - val: 3
          name: "third_update"

  - name: "DROP counter trigger"
    sql: "DROP TRIGGER counter_trigger"
    expect:
      affected_rows: 0

  - name: "UPDATE without trigger - counter should NOT change"
    sql: "UPDATE trigger_test SET name = 'no_trigger_update' WHERE id = 100"
    expect:
      affected_rows: 1

  - name: "Verify counter unchanged after trigger dropped"
    sql: "SELECT val, name FROM trigger_test WHERE id = 100"
    expect:
      data:
        - val: 3
          name: "no_trigger_update"

  # BEGIN...END block tests (statements must end with semicolon - MySQL compatible)
  - name: "Clean up for BEGIN...END test"
    sql: "DELETE FROM trigger_test"
    expect:
      affected_rows_any: true

  - name: "CREATE BEFORE INSERT trigger with BEGIN...END"
    sql: "CREATE TRIGGER begin_end_trigger BEFORE INSERT ON trigger_test FOR EACH ROW BEGIN SET NEW.val = 777; END"
    expect:
      affected_rows: 0

  - name: "INSERT with BEGIN...END trigger"
    sql: "INSERT INTO trigger_test (id, val, name) VALUES (200, 1, 'begin_end_test')"
    expect:
      affected_rows: 1

  - name: "Verify BEGIN...END trigger modified value"
    sql: "SELECT id, val, name FROM trigger_test WHERE id = 200"
    expect:
      rows: 1
      data:
        - id: 200
          val: 777
          name: "begin_end_test"

  - name: "DROP BEGIN...END trigger"
    sql: "DROP TRIGGER begin_end_trigger"
    expect:
      affected_rows: 0

  - name: "CREATE BEFORE INSERT trigger with multiple SET in BEGIN...END"
    sql: "CREATE TRIGGER multi_set_trigger BEFORE INSERT ON trigger_test FOR EACH ROW BEGIN SET NEW.val = 999; SET NEW.name = 'modified'; END"
    expect:
      affected_rows: 0

  - name: "INSERT with multiple SET trigger"
    sql: "INSERT INTO trigger_test (id, val, name) VALUES (202, 1, 'original')"
    expect:
      affected_rows: 1

  - name: "Verify multiple SET trigger modified both values"
    sql: "SELECT id, val, name FROM trigger_test WHERE id = 202"
    expect:
      rows: 1
      data:
        - id: 202
          val: 999
          name: "modified"

  - name: "DROP multiple SET trigger"
    sql: "DROP TRIGGER multi_set_trigger"
    expect:
      affected_rows: 0

  # AFTER trigger tests (INSERT INTO from trigger)
  - name: "Clean up for AFTER trigger test"
    sql: "DELETE FROM trigger_test"
    expect:
      affected_rows_any: true

  - name: "Clear trigger_log table"
    sql: "DELETE FROM trigger_log"
    expect:
      affected_rows_any: true

  - name: "CREATE AFTER INSERT trigger with INSERT INTO"

    sql: "CREATE TRIGGER after_ins_log AFTER INSERT ON trigger_test FOR EACH ROW BEGIN INSERT INTO trigger_log (id, action, new_val) VALUES (NEW.id, 'insert', NEW.val); END"
    expect:
      affected_rows: 0

  - name: "INSERT triggers AFTER INSERT"

    sql: "INSERT INTO trigger_test (id, val, name) VALUES (300, 42, 'after_test')"
    expect:
      affected_rows: 1

  - name: "Verify AFTER INSERT trigger logged the action"

    sql: "SELECT id, action, new_val FROM trigger_log WHERE id = 300"
    expect:
      rows: 1
      data:
        - id: 300
          action: "insert"
          new_val: 42

  - name: "DROP AFTER INSERT trigger"

    sql: "DROP TRIGGER IF EXISTS after_ins_log"
    expect:
      affected_rows: 0

  # IF...THEN...END IF tests (MySQL trigger control flow)
  - name: "Clean up for IF test"
    sql: "DELETE FROM trigger_test"
    expect:
      affected_rows_any: true

  - name: "CREATE trigger with IF...THEN...END IF"

    sql: "CREATE TRIGGER if_trigger BEFORE INSERT ON trigger_test FOR EACH ROW BEGIN IF NEW.val > 100 THEN SET NEW.val = 100; END IF; END"
    expect:
      affected_rows: 0

  - name: "INSERT with value > 100 should be capped"

    sql: "INSERT INTO trigger_test (id, val, name) VALUES (400, 999, 'if_test')"
    expect:
      affected_rows: 1

  - name: "Verify IF trigger capped value to 100"

    sql: "SELECT val FROM trigger_test WHERE id = 400"
    expect:
      data:
        - val: 100

  - name: "INSERT with value <= 100 should not be changed"

    sql: "INSERT INTO trigger_test (id, val, name) VALUES (401, 50, 'if_test2')"
    expect:
      affected_rows: 1

  - name: "Verify IF trigger did not change value <= 100"

    sql: "SELECT val FROM trigger_test WHERE id = 401"
    expect:
      data:
        - val: 50

  - name: "DROP IF trigger"

    sql: "DROP TRIGGER IF EXISTS if_trigger"
    expect:
      affected_rows: 0

  # Test IF false does NOT set column to NULL (ELSE branch test)
  - name: "Clean up for IF false test"
    sql: "DELETE FROM trigger_test"
    expect:
      affected_rows_any: true

  - name: "CREATE trigger with SET before IF"

    sql: "CREATE TRIGGER if_else_trigger BEFORE INSERT ON trigger_test FOR EACH ROW BEGIN SET NEW.name = 'always'; IF NEW.val > 100 THEN SET NEW.val = 100; END IF; END"
    expect:
      affected_rows: 0

  - name: "INSERT with IF false - val should NOT be NULL or changed"

    sql: "INSERT INTO trigger_test (id, val, name) VALUES (450, 42, 'original')"
    expect:
      affected_rows: 1

  - name: "Verify IF false keeps original val AND applies prior SET"

    sql: "SELECT id, val, name FROM trigger_test WHERE id = 450"
    expect:
      rows: 1
      data:
        - id: 450
          val: 42
          name: "always"

  - name: "INSERT with IF true - both modifications applied"

    sql: "INSERT INTO trigger_test (id, val, name) VALUES (451, 200, 'original')"
    expect:
      affected_rows: 1

  - name: "Verify IF true applies both modifications"

    sql: "SELECT id, val, name FROM trigger_test WHERE id = 451"
    expect:
      rows: 1
      data:
        - id: 451
          val: 100
          name: "always"

  - name: "DROP IF ELSE trigger"

    sql: "DROP TRIGGER IF EXISTS if_else_trigger"
    expect:
      affected_rows: 0

  # DELETE trigger tests
  - name: "Clean up for DELETE trigger test"
    sql: "DELETE FROM trigger_test"
    expect:
      affected_rows_any: true

  - name: "Clear trigger_log for DELETE test"
    sql: "DELETE FROM trigger_log"
    expect:
      affected_rows_any: true

  - name: "Insert row for DELETE trigger test"
    sql: "INSERT INTO trigger_test (id, val, name) VALUES (500, 77, 'delete_test')"
    expect:
      affected_rows: 1

  - name: "CREATE AFTER DELETE trigger"

    sql: "CREATE TRIGGER after_del_log AFTER DELETE ON trigger_test FOR EACH ROW BEGIN INSERT INTO trigger_log (id, action, old_val) VALUES (OLD.id, 'delete', OLD.val); END"
    expect:
      affected_rows: 0

  - name: "DELETE triggers AFTER DELETE"

    sql: "DELETE FROM trigger_test WHERE id = 500"
    expect:
      affected_rows: 1

  - name: "Verify AFTER DELETE trigger logged the action"

    sql: "SELECT id, action, old_val FROM trigger_log WHERE id = 500"
    expect:
      rows: 1
      data:
        - id: 500
          action: "delete"
          old_val: 77

  - name: "DROP AFTER DELETE trigger"

    sql: "DROP TRIGGER IF EXISTS after_del_log"
    expect:
      affected_rows: 0

  # --- Trigger persistence: set up multiple triggers, SHUTDOWN, verify ---
  - name: "Clean up for persistence test"
    sql: "DELETE FROM trigger_test"
    expect:
      affected_rows_any: true

  - name: "Clear trigger_log for persistence test"
    sql: "DELETE FROM trigger_log"
    expect:
      affected_rows_any: true

  - name: "CREATE BEFORE INSERT trigger for persistence"
    sql: "CREATE TRIGGER persist_bi BEFORE INSERT ON trigger_test FOR EACH ROW SET NEW.val = NEW.val + 1000"
    expect:
      affected_rows: 0

  - name: "CREATE BEFORE UPDATE trigger for persistence"
    sql: "CREATE TRIGGER persist_bu BEFORE UPDATE ON trigger_test FOR EACH ROW SET NEW.val = OLD.val + 1"
    expect:
      affected_rows: 0

  - name: "Verify triggers work before SHUTDOWN"
    sql: "INSERT INTO trigger_test (id, val, name) VALUES (900, 5, 'persist_test')"
    expect:
      affected_rows: 1

  - name: "Verify BEFORE INSERT trigger applied before SHUTDOWN"
    sql: "SELECT val FROM trigger_test WHERE id = 900"
    expect:
      data:
        - val: 1005

  - name: "Verify BEFORE UPDATE trigger works before SHUTDOWN"
    sql: "UPDATE trigger_test SET name = 'updated' WHERE id = 900"
    expect:
      affected_rows: 1

  - name: "Verify counter incremented before SHUTDOWN"
    sql: "SELECT val, name FROM trigger_test WHERE id = 900"
    expect:
      data:
        - val: 1006
          name: "updated"

  - name: "SHUTDOWN for trigger persistence test"
    sql: "SHUTDOWN"
    expect:
      rows: 0

  - name: "After restart: verify data survived"
    sql: "SELECT val, name FROM trigger_test WHERE id = 900"
    expect:
      data:
        - val: 1006
          name: "updated"

  - name: "After restart: BEFORE INSERT trigger still works"
    sql: "INSERT INTO trigger_test (id, val, name) VALUES (901, 10, 'after_restart')"
    expect:
      affected_rows: 1

  - name: "After restart: verify BEFORE INSERT trigger applied"
    sql: "SELECT val FROM trigger_test WHERE id = 901"
    expect:
      data:
        - val: 1010

  - name: "After restart: BEFORE UPDATE trigger still works"
    sql: "UPDATE trigger_test SET name = 'restarted' WHERE id = 900"
    expect:
      affected_rows: 1

  - name: "After restart: verify BEFORE UPDATE trigger incremented"
    sql: "SELECT val, name FROM trigger_test WHERE id = 900"
    expect:
      data:
        - val: 1007
          name: "restarted"

  - name: "After restart: DROP persisted trigger"
    sql: "DROP TRIGGER persist_bi"
    expect:
      affected_rows: 0

  - name: "After restart: INSERT without dropped trigger"
    sql: "INSERT INTO trigger_test (id, val, name) VALUES (902, 42, 'no_trigger')"
    expect:
      affected_rows: 1

  - name: "After restart: verify trigger no longer applies"
    sql: "SELECT val FROM trigger_test WHERE id = 902"
    expect:
      data:
        - val: 42

  - name: "Cleanup remaining trigger"
    sql: "DROP TRIGGER IF EXISTS persist_bu"
    expect:
      affected_rows: 0

  # --- Trigger + INSERT IGNORE interaction ---
  - name: "Create table with PK for INSERT IGNORE trigger test"
    sql: "CREATE TABLE trigger_ignore_t (id INT PRIMARY KEY, val INT, name VARCHAR(50))"
    expect:
      affected_rows: 0

  - name: "CREATE BEFORE INSERT trigger on PK table"
    sql: "CREATE TRIGGER ignore_bi BEFORE INSERT ON trigger_ignore_t FOR EACH ROW SET NEW.val = NEW.val + 1000"
    expect:
      affected_rows: 0

  - name: "Insert base row for PK conflict"
    sql: "INSERT INTO trigger_ignore_t (id, val, name) VALUES (600, 1, 'base')"
    expect:
      affected_rows: 1

  - name: "Verify base row has trigger-modified value"
    sql: "SELECT val FROM trigger_ignore_t WHERE id = 600"
    expect:
      data:
        - val: 1001

  - name: "INSERT IGNORE with PK conflict skips duplicate"
    sql: "INSERT IGNORE INTO trigger_ignore_t (id, val, name) VALUES (600, 2, 'dup'), (601, 3, 'new')"
    expect:
      affected_rows: 1

  - name: "Verify original row unchanged and new row has trigger value"
    sql: "SELECT id, val FROM trigger_ignore_t WHERE id IN (600, 601) ORDER BY id"
    expect:
      rows: 2
      data:
        - { id: 600, val: 1001 }
        - { id: 601, val: 1003 }

  - name: "DROP INSERT IGNORE trigger"
    sql: "DROP TRIGGER IF EXISTS ignore_bi"
    expect:
      affected_rows: 0

  - name: "Drop INSERT IGNORE test table"
    sql: "DROP TABLE IF EXISTS trigger_ignore_t"
    expect:
      affected_rows: 0

  # --- AFTER INSERT trigger: insert into another table ---
  - name: "Clean up for AFTER INSERT cross-table trigger test"
    sql: "DELETE FROM trigger_test"
    expect:
      affected_rows_any: true

  - name: "Clear trigger_log for cross-table test"
    sql: "DELETE FROM trigger_log"
    expect:
      affected_rows_any: true

  - name: "CREATE AFTER INSERT trigger that logs to another table"
    sql: "CREATE TRIGGER after_ins_cross AFTER INSERT ON trigger_test FOR EACH ROW BEGIN INSERT INTO trigger_log (id, action, new_val) VALUES (NEW.id, 'cross_insert', NEW.val); END"
    expect:
      affected_rows: 0

  - name: "Insert row triggers cross-table AFTER INSERT"
    sql: "INSERT INTO trigger_test (id, val, name) VALUES (700, 42, 'cross_test')"
    expect:
      affected_rows: 1

  - name: "Verify AFTER INSERT logged to trigger_log"
    sql: "SELECT id, action, new_val FROM trigger_log WHERE id = 700"
    expect:
      rows: 1
      data:
        - { id: 700, action: "cross_insert", new_val: 42 }

  - name: "Insert multiple rows, each triggers cross-table log"
    sql: "INSERT INTO trigger_test (id, val, name) VALUES (701, 10, 'multi1'), (702, 20, 'multi2')"
    expect:
      affected_rows: 2

  - name: "Verify multiple AFTER INSERT log entries"
    sql: "SELECT id, action, new_val FROM trigger_log WHERE id IN (701, 702) ORDER BY id"
    expect:
      rows: 2
      data:
        - { id: 701, action: "cross_insert", new_val: 10 }
        - { id: 702, action: "cross_insert", new_val: 20 }

  - name: "DROP cross-table AFTER INSERT trigger"
    sql: "DROP TRIGGER IF EXISTS after_ins_cross"
    expect:
      affected_rows: 0

  # --- BEFORE UPDATE trigger with complex modification ---
  - name: "Clean up for complex BEFORE UPDATE test"
    sql: "DELETE FROM trigger_test"
    expect:
      affected_rows_any: true

  - name: "Insert rows for complex UPDATE trigger test"
    sql: "INSERT INTO trigger_test (id, val, name) VALUES (800, 50, 'test1'), (801, 100, 'test2')"
    expect:
      affected_rows: 2

  - name: "CREATE BEFORE UPDATE trigger with IF condition"
    sql: "CREATE TRIGGER guard_update BEFORE UPDATE ON trigger_test FOR EACH ROW BEGIN IF NEW.val > 1000 THEN SET NEW.val = 1000; END IF; END"
    expect:
      affected_rows: 0

  - name: "UPDATE within limit passes through"
    sql: "UPDATE trigger_test SET val = 500 WHERE id = 800"
    expect:
      affected_rows: 1

  - name: "Verify within-limit UPDATE"
    sql: "SELECT val FROM trigger_test WHERE id = 800"
    expect:
      data:
        - val: 500

  - name: "UPDATE exceeding limit gets capped by trigger"
    sql: "UPDATE trigger_test SET val = 9999 WHERE id = 801"
    expect:
      affected_rows: 1

  - name: "Verify over-limit UPDATE was capped to 1000"
    sql: "SELECT val FROM trigger_test WHERE id = 801"
    expect:
      data:
        - val: 1000

  - name: "DROP guard UPDATE trigger"
    sql: "DROP TRIGGER IF EXISTS guard_update"
    expect:
      affected_rows: 0
