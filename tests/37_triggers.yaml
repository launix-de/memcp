# Trigger Infrastructure Tests
# Testing SQL CREATE/DROP TRIGGER and basic trigger execution

metadata:
  version: "1.0"
  description: "SQL trigger infrastructure tests"

cleanup:
  - action: "Clean up test tables"
    sql: "DROP TABLE IF EXISTS trigger_test"
  - action: "Clean up log table"
    sql: "DROP TABLE IF EXISTS trigger_log"

setup:
  - action: "Create test table"
    sql: "CREATE TABLE trigger_test (id INT, val INT, name VARCHAR(50))"
  - action: "Create log table for trigger testing"
    sql: "CREATE TABLE trigger_log (id INT, action VARCHAR(20), old_val INT, new_val INT)"

test_cases:
  # Basic table operations should still work
  - name: "Basic INSERT works"
    sql: "INSERT INTO trigger_test (id, val, name) VALUES (1, 100, 'test')"
    expect:
      affected_rows: 1

  - name: "Basic SELECT works"
    sql: "SELECT id, val, name FROM trigger_test WHERE id = 1"
    expect:
      rows: 1
      data:
        - id: 1
          val: 100
          name: "test"

  - name: "Basic UPDATE works"
    sql: "UPDATE trigger_test SET val = 200 WHERE id = 1"
    expect:
      affected_rows: 1

  - name: "Verify UPDATE"
    sql: "SELECT val FROM trigger_test WHERE id = 1"
    expect:
      data:
        - val: 200

  - name: "Basic DELETE works"
    sql: "DELETE FROM trigger_test WHERE id = 1"
    expect:
      affected_rows: 1

  - name: "Verify DELETE"
    sql: "SELECT COUNT(*) as cnt FROM trigger_test"
    expect:
      data:
        - cnt: 0

  # BEFORE INSERT trigger tests
  - name: "CREATE BEFORE INSERT trigger"
    sql: "CREATE TRIGGER before_ins_trigger BEFORE INSERT ON trigger_test FOR EACH ROW SET NEW.val = 999"
    expect:
      affected_rows: 0

  - name: "INSERT with BEFORE INSERT trigger - value should be modified"
    sql: "INSERT INTO trigger_test (id, val, name) VALUES (10, 100, 'triggered')"
    expect:
      affected_rows: 1

  - name: "Verify BEFORE INSERT trigger modified the value"
    sql: "SELECT id, val, name FROM trigger_test WHERE id = 10"
    expect:
      rows: 1
      data:
        - id: 10
          val: 999
          name: "triggered"

  - name: "DROP TRIGGER"
    sql: "DROP TRIGGER before_ins_trigger"
    expect:
      affected_rows: 0

  - name: "INSERT after DROP TRIGGER - value should NOT be modified"
    sql: "INSERT INTO trigger_test (id, val, name) VALUES (11, 100, 'no_trigger')"
    expect:
      affected_rows: 1

  - name: "Verify value is NOT modified after trigger dropped"
    sql: "SELECT id, val, name FROM trigger_test WHERE id = 11"
    expect:
      rows: 1
      data:
        - id: 11
          val: 100
          name: "no_trigger"

  # BEFORE INSERT trigger with expression using NEW column
  - name: "CREATE BEFORE INSERT trigger with expression"
    sql: "CREATE TRIGGER calc_trigger BEFORE INSERT ON trigger_test FOR EACH ROW SET NEW.val = NEW.id * 10"
    expect:
      affected_rows: 0

  - name: "INSERT with expression trigger"
    sql: "INSERT INTO trigger_test (id, val, name) VALUES (5, 1, 'calc')"
    expect:
      affected_rows: 1

  - name: "Verify expression trigger calculated value"
    sql: "SELECT id, val, name FROM trigger_test WHERE id = 5"
    expect:
      rows: 1
      data:
        - id: 5
          val: 50
          name: "calc"

  - name: "DROP expression trigger"
    sql: "DROP TRIGGER calc_trigger"
    expect:
      affected_rows: 0

  # DROP TRIGGER IF EXISTS
  - name: "DROP TRIGGER IF EXISTS - non-existent trigger"
    sql: "DROP TRIGGER IF EXISTS nonexistent_trigger"
    expect:
      affected_rows: 0

  # BEFORE UPDATE trigger tests with OLD/NEW comparison
  - name: "Clean up for UPDATE trigger test"
    sql: "DELETE FROM trigger_test"
    expect:
      affected_rows_any: true

  - name: "Insert row for UPDATE trigger test"
    sql: "INSERT INTO trigger_test (id, val, name) VALUES (100, 0, 'counter_test')"
    expect:
      affected_rows: 1

  - name: "CREATE BEFORE UPDATE trigger with OLD reference"
    sql: "CREATE TRIGGER counter_trigger BEFORE UPDATE ON trigger_test FOR EACH ROW SET NEW.val = OLD.val + 1"
    expect:
      affected_rows: 0

  - name: "Verify initial value"
    sql: "SELECT val FROM trigger_test WHERE id = 100"
    expect:
      data:
        - val: 0

  - name: "First UPDATE - trigger should increment counter"
    sql: "UPDATE trigger_test SET name = 'first_update' WHERE id = 100"
    expect:
      affected_rows: 1

  - name: "Verify counter after first UPDATE"
    sql: "SELECT val, name FROM trigger_test WHERE id = 100"
    expect:
      data:
        - val: 1
          name: "first_update"

  - name: "Second UPDATE - trigger should increment counter again"
    sql: "UPDATE trigger_test SET name = 'second_update' WHERE id = 100"
    expect:
      affected_rows: 1

  - name: "Verify counter after second UPDATE"
    sql: "SELECT val, name FROM trigger_test WHERE id = 100"
    expect:
      data:
        - val: 2
          name: "second_update"

  - name: "Third UPDATE - trigger should increment counter again"
    sql: "UPDATE trigger_test SET name = 'third_update' WHERE id = 100"
    expect:
      affected_rows: 1

  - name: "Verify counter after third UPDATE"
    sql: "SELECT val, name FROM trigger_test WHERE id = 100"
    expect:
      data:
        - val: 3
          name: "third_update"

  - name: "DROP counter trigger"
    sql: "DROP TRIGGER counter_trigger"
    expect:
      affected_rows: 0

  - name: "UPDATE without trigger - counter should NOT change"
    sql: "UPDATE trigger_test SET name = 'no_trigger_update' WHERE id = 100"
    expect:
      affected_rows: 1

  - name: "Verify counter unchanged after trigger dropped"
    sql: "SELECT val, name FROM trigger_test WHERE id = 100"
    expect:
      data:
        - val: 3
          name: "no_trigger_update"

  # BEGIN...END block tests (statements must end with semicolon - MySQL compatible)
  - name: "Clean up for BEGIN...END test"
    sql: "DELETE FROM trigger_test"
    expect:
      affected_rows_any: true

  - name: "CREATE BEFORE INSERT trigger with BEGIN...END"
    sql: "CREATE TRIGGER begin_end_trigger BEFORE INSERT ON trigger_test FOR EACH ROW BEGIN SET NEW.val = 777; END"
    expect:
      affected_rows: 0

  - name: "INSERT with BEGIN...END trigger"
    sql: "INSERT INTO trigger_test (id, val, name) VALUES (200, 1, 'begin_end_test')"
    expect:
      affected_rows: 1

  - name: "Verify BEGIN...END trigger modified value"
    sql: "SELECT id, val, name FROM trigger_test WHERE id = 200"
    expect:
      rows: 1
      data:
        - id: 200
          val: 777
          name: "begin_end_test"

  - name: "DROP BEGIN...END trigger"
    sql: "DROP TRIGGER begin_end_trigger"
    expect:
      affected_rows: 0

  - name: "CREATE BEFORE INSERT trigger with multiple SET in BEGIN...END"
    sql: "CREATE TRIGGER multi_set_trigger BEFORE INSERT ON trigger_test FOR EACH ROW BEGIN SET NEW.val = 999; SET NEW.name = 'modified'; END"
    expect:
      affected_rows: 0

  - name: "INSERT with multiple SET trigger"
    sql: "INSERT INTO trigger_test (id, val, name) VALUES (202, 1, 'original')"
    expect:
      affected_rows: 1

  - name: "Verify multiple SET trigger modified both values"
    sql: "SELECT id, val, name FROM trigger_test WHERE id = 202"
    expect:
      rows: 1
      data:
        - id: 202
          val: 999
          name: "modified"

  - name: "DROP multiple SET trigger"
    sql: "DROP TRIGGER multi_set_trigger"
    expect:
      affected_rows: 0

  # AFTER trigger tests (INSERT INTO from trigger)
  - name: "Clean up for AFTER trigger test"
    sql: "DELETE FROM trigger_test"
    expect:
      affected_rows_any: true

  - name: "Clear trigger_log table"
    sql: "DELETE FROM trigger_log"
    expect:
      affected_rows_any: true

  - name: "CREATE AFTER INSERT trigger with INSERT INTO"

    sql: "CREATE TRIGGER after_ins_log AFTER INSERT ON trigger_test FOR EACH ROW BEGIN INSERT INTO trigger_log (id, action, new_val) VALUES (NEW.id, 'insert', NEW.val); END"
    expect:
      affected_rows: 0

  - name: "INSERT triggers AFTER INSERT"

    sql: "INSERT INTO trigger_test (id, val, name) VALUES (300, 42, 'after_test')"
    expect:
      affected_rows: 1

  - name: "Verify AFTER INSERT trigger logged the action"

    sql: "SELECT id, action, new_val FROM trigger_log WHERE id = 300"
    expect:
      rows: 1
      data:
        - id: 300
          action: "insert"
          new_val: 42

  - name: "DROP AFTER INSERT trigger"

    sql: "DROP TRIGGER IF EXISTS after_ins_log"
    expect:
      affected_rows: 0

  # IF...THEN...END IF tests (MySQL trigger control flow)
  - name: "Clean up for IF test"
    sql: "DELETE FROM trigger_test"
    expect:
      affected_rows_any: true

  - name: "CREATE trigger with IF...THEN...END IF"

    sql: "CREATE TRIGGER if_trigger BEFORE INSERT ON trigger_test FOR EACH ROW BEGIN IF NEW.val > 100 THEN SET NEW.val = 100; END IF; END"
    expect:
      affected_rows: 0

  - name: "INSERT with value > 100 should be capped"

    sql: "INSERT INTO trigger_test (id, val, name) VALUES (400, 999, 'if_test')"
    expect:
      affected_rows: 1

  - name: "Verify IF trigger capped value to 100"

    sql: "SELECT val FROM trigger_test WHERE id = 400"
    expect:
      data:
        - val: 100

  - name: "INSERT with value <= 100 should not be changed"

    sql: "INSERT INTO trigger_test (id, val, name) VALUES (401, 50, 'if_test2')"
    expect:
      affected_rows: 1

  - name: "Verify IF trigger did not change value <= 100"

    sql: "SELECT val FROM trigger_test WHERE id = 401"
    expect:
      data:
        - val: 50

  - name: "DROP IF trigger"

    sql: "DROP TRIGGER IF EXISTS if_trigger"
    expect:
      affected_rows: 0

  # Test IF false does NOT set column to NULL (ELSE branch test)
  - name: "Clean up for IF false test"
    sql: "DELETE FROM trigger_test"
    expect:
      affected_rows_any: true

  - name: "CREATE trigger with SET before IF"

    sql: "CREATE TRIGGER if_else_trigger BEFORE INSERT ON trigger_test FOR EACH ROW BEGIN SET NEW.name = 'always'; IF NEW.val > 100 THEN SET NEW.val = 100; END IF; END"
    expect:
      affected_rows: 0

  - name: "INSERT with IF false - val should NOT be NULL or changed"

    sql: "INSERT INTO trigger_test (id, val, name) VALUES (450, 42, 'original')"
    expect:
      affected_rows: 1

  - name: "Verify IF false keeps original val AND applies prior SET"

    sql: "SELECT id, val, name FROM trigger_test WHERE id = 450"
    expect:
      rows: 1
      data:
        - id: 450
          val: 42
          name: "always"

  - name: "INSERT with IF true - both modifications applied"

    sql: "INSERT INTO trigger_test (id, val, name) VALUES (451, 200, 'original')"
    expect:
      affected_rows: 1

  - name: "Verify IF true applies both modifications"

    sql: "SELECT id, val, name FROM trigger_test WHERE id = 451"
    expect:
      rows: 1
      data:
        - id: 451
          val: 100
          name: "always"

  - name: "DROP IF ELSE trigger"

    sql: "DROP TRIGGER IF EXISTS if_else_trigger"
    expect:
      affected_rows: 0

  # DELETE trigger tests
  - name: "Clean up for DELETE trigger test"
    sql: "DELETE FROM trigger_test"
    expect:
      affected_rows_any: true

  - name: "Clear trigger_log for DELETE test"
    sql: "DELETE FROM trigger_log"
    expect:
      affected_rows_any: true

  - name: "Insert row for DELETE trigger test"
    sql: "INSERT INTO trigger_test (id, val, name) VALUES (500, 77, 'delete_test')"
    expect:
      affected_rows: 1

  - name: "CREATE AFTER DELETE trigger"

    sql: "CREATE TRIGGER after_del_log AFTER DELETE ON trigger_test FOR EACH ROW BEGIN INSERT INTO trigger_log (id, action, old_val) VALUES (OLD.id, 'delete', OLD.val); END"
    expect:
      affected_rows: 0

  - name: "DELETE triggers AFTER DELETE"

    sql: "DELETE FROM trigger_test WHERE id = 500"
    expect:
      affected_rows: 1

  - name: "Verify AFTER DELETE trigger logged the action"

    sql: "SELECT id, action, old_val FROM trigger_log WHERE id = 500"
    expect:
      rows: 1
      data:
        - id: 500
          action: "delete"
          old_val: 77

  - name: "DROP AFTER DELETE trigger"

    sql: "DROP TRIGGER IF EXISTS after_del_log"
    expect:
      affected_rows: 0

  # --- Trigger persistence: set up multiple triggers, SHUTDOWN, verify ---
  - name: "Clean up for persistence test"
    sql: "DELETE FROM trigger_test"
    expect:
      affected_rows_any: true

  - name: "Clear trigger_log for persistence test"
    sql: "DELETE FROM trigger_log"
    expect:
      affected_rows_any: true

  - name: "CREATE BEFORE INSERT trigger for persistence"
    sql: "CREATE TRIGGER persist_bi BEFORE INSERT ON trigger_test FOR EACH ROW SET NEW.val = NEW.val + 1000"
    expect:
      affected_rows: 0

  - name: "CREATE BEFORE UPDATE trigger for persistence"
    sql: "CREATE TRIGGER persist_bu BEFORE UPDATE ON trigger_test FOR EACH ROW SET NEW.val = OLD.val + 1"
    expect:
      affected_rows: 0

  - name: "Verify triggers work before SHUTDOWN"
    sql: "INSERT INTO trigger_test (id, val, name) VALUES (900, 5, 'persist_test')"
    expect:
      affected_rows: 1

  - name: "Verify BEFORE INSERT trigger applied before SHUTDOWN"
    sql: "SELECT val FROM trigger_test WHERE id = 900"
    expect:
      data:
        - val: 1005

  - name: "Verify BEFORE UPDATE trigger works before SHUTDOWN"
    sql: "UPDATE trigger_test SET name = 'updated' WHERE id = 900"
    expect:
      affected_rows: 1

  - name: "Verify counter incremented before SHUTDOWN"
    sql: "SELECT val, name FROM trigger_test WHERE id = 900"
    expect:
      data:
        - val: 1006
          name: "updated"

  - name: "SHUTDOWN for trigger persistence test"
    sql: "SHUTDOWN"
    expect:
      rows: 0

  - name: "After restart: verify data survived"
    sql: "SELECT val, name FROM trigger_test WHERE id = 900"
    expect:
      data:
        - val: 1006
          name: "updated"

  - name: "After restart: BEFORE INSERT trigger still works"
    sql: "INSERT INTO trigger_test (id, val, name) VALUES (901, 10, 'after_restart')"
    expect:
      affected_rows: 1

  - name: "After restart: verify BEFORE INSERT trigger applied"
    sql: "SELECT val FROM trigger_test WHERE id = 901"
    expect:
      data:
        - val: 1010

  - name: "After restart: BEFORE UPDATE trigger still works"
    sql: "UPDATE trigger_test SET name = 'restarted' WHERE id = 900"
    expect:
      affected_rows: 1

  - name: "After restart: verify BEFORE UPDATE trigger incremented"
    sql: "SELECT val, name FROM trigger_test WHERE id = 900"
    expect:
      data:
        - val: 1007
          name: "restarted"

  - name: "After restart: DROP persisted trigger"
    sql: "DROP TRIGGER persist_bi"
    expect:
      affected_rows: 0

  - name: "After restart: INSERT without dropped trigger"
    sql: "INSERT INTO trigger_test (id, val, name) VALUES (902, 42, 'no_trigger')"
    expect:
      affected_rows: 1

  - name: "After restart: verify trigger no longer applies"
    sql: "SELECT val FROM trigger_test WHERE id = 902"
    expect:
      data:
        - val: 42

  - name: "Cleanup remaining trigger"
    sql: "DROP TRIGGER IF EXISTS persist_bu"
    expect:
      affected_rows: 0

  # --- Trigger + INSERT IGNORE interaction ---
  - name: "Create table with PK for INSERT IGNORE trigger test"
    sql: "CREATE TABLE trigger_ignore_t (id INT PRIMARY KEY, val INT, name VARCHAR(50))"
    expect:
      affected_rows: 0

  - name: "CREATE BEFORE INSERT trigger on PK table"
    sql: "CREATE TRIGGER ignore_bi BEFORE INSERT ON trigger_ignore_t FOR EACH ROW SET NEW.val = NEW.val + 1000"
    expect:
      affected_rows: 0

  - name: "Insert base row for PK conflict"
    sql: "INSERT INTO trigger_ignore_t (id, val, name) VALUES (600, 1, 'base')"
    expect:
      affected_rows: 1

  - name: "Verify base row has trigger-modified value"
    sql: "SELECT val FROM trigger_ignore_t WHERE id = 600"
    expect:
      data:
        - val: 1001

  - name: "INSERT IGNORE with PK conflict skips duplicate"
    sql: "INSERT IGNORE INTO trigger_ignore_t (id, val, name) VALUES (600, 2, 'dup'), (601, 3, 'new')"
    expect:
      affected_rows: 1

  - name: "Verify original row unchanged and new row has trigger value"
    sql: "SELECT id, val FROM trigger_ignore_t WHERE id IN (600, 601) ORDER BY id"
    expect:
      rows: 2
      data:
        - { id: 600, val: 1001 }
        - { id: 601, val: 1003 }

  - name: "DROP INSERT IGNORE trigger"
    sql: "DROP TRIGGER IF EXISTS ignore_bi"
    expect:
      affected_rows: 0

  - name: "Drop INSERT IGNORE test table"
    sql: "DROP TABLE IF EXISTS trigger_ignore_t"
    expect:
      affected_rows: 0

  # --- AFTER INSERT trigger: insert into another table ---
  - name: "Clean up for AFTER INSERT cross-table trigger test"
    sql: "DELETE FROM trigger_test"
    expect:
      affected_rows_any: true

  - name: "Clear trigger_log for cross-table test"
    sql: "DELETE FROM trigger_log"
    expect:
      affected_rows_any: true

  - name: "CREATE AFTER INSERT trigger that logs to another table"
    sql: "CREATE TRIGGER after_ins_cross AFTER INSERT ON trigger_test FOR EACH ROW BEGIN INSERT INTO trigger_log (id, action, new_val) VALUES (NEW.id, 'cross_insert', NEW.val); END"
    expect:
      affected_rows: 0

  - name: "Insert row triggers cross-table AFTER INSERT"
    sql: "INSERT INTO trigger_test (id, val, name) VALUES (700, 42, 'cross_test')"
    expect:
      affected_rows: 1

  - name: "Verify AFTER INSERT logged to trigger_log"
    sql: "SELECT id, action, new_val FROM trigger_log WHERE id = 700"
    expect:
      rows: 1
      data:
        - { id: 700, action: "cross_insert", new_val: 42 }

  - name: "Insert multiple rows, each triggers cross-table log"
    sql: "INSERT INTO trigger_test (id, val, name) VALUES (701, 10, 'multi1'), (702, 20, 'multi2')"
    expect:
      affected_rows: 2

  - name: "Verify multiple AFTER INSERT log entries"
    sql: "SELECT id, action, new_val FROM trigger_log WHERE id IN (701, 702) ORDER BY id"
    expect:
      rows: 2
      data:
        - { id: 701, action: "cross_insert", new_val: 10 }
        - { id: 702, action: "cross_insert", new_val: 20 }

  - name: "DROP cross-table AFTER INSERT trigger"
    sql: "DROP TRIGGER IF EXISTS after_ins_cross"
    expect:
      affected_rows: 0

  # --- BEFORE UPDATE trigger with complex modification ---
  - name: "Clean up for complex BEFORE UPDATE test"
    sql: "DELETE FROM trigger_test"
    expect:
      affected_rows_any: true

  - name: "Insert rows for complex UPDATE trigger test"
    sql: "INSERT INTO trigger_test (id, val, name) VALUES (800, 50, 'test1'), (801, 100, 'test2')"
    expect:
      affected_rows: 2

  - name: "CREATE BEFORE UPDATE trigger with IF condition"
    sql: "CREATE TRIGGER guard_update BEFORE UPDATE ON trigger_test FOR EACH ROW BEGIN IF NEW.val > 1000 THEN SET NEW.val = 1000; END IF; END"
    expect:
      affected_rows: 0

  - name: "UPDATE within limit passes through"
    sql: "UPDATE trigger_test SET val = 500 WHERE id = 800"
    expect:
      affected_rows: 1

  - name: "Verify within-limit UPDATE"
    sql: "SELECT val FROM trigger_test WHERE id = 800"
    expect:
      data:
        - val: 500

  - name: "UPDATE exceeding limit gets capped by trigger"
    sql: "UPDATE trigger_test SET val = 9999 WHERE id = 801"
    expect:
      affected_rows: 1

  - name: "Verify over-limit UPDATE was capped to 1000"
    sql: "SELECT val FROM trigger_test WHERE id = 801"
    expect:
      data:
        - val: 1000

  - name: "DROP guard UPDATE trigger"
    sql: "DROP TRIGGER IF EXISTS guard_update"
    expect:
      affected_rows: 0

  # =====================================================
  # BEFORE DELETE trigger tests (coverage gap: 11.1%)
  # =====================================================

  - name: "Clean up for BEFORE DELETE trigger test"
    sql: "DELETE FROM trigger_test"
    expect:
      affected_rows_any: true

  - name: "Insert rows for BEFORE DELETE test"
    sql: "INSERT INTO trigger_test (id, val, name) VALUES (900, 10, 'keep'), (901, 20, 'del1'), (902, 30, 'del2')"
    expect:
      affected_rows: 3

  - name: "Clear trigger_log for BEFORE DELETE test"
    sql: "DELETE FROM trigger_log"
    expect:
      affected_rows_any: true

  - name: "CREATE BEFORE DELETE trigger that logs OLD values"
    sql: "CREATE TRIGGER bd_log_old BEFORE DELETE ON trigger_test FOR EACH ROW BEGIN INSERT INTO trigger_log (id, action, old_val) VALUES (OLD.id, 'before_delete', OLD.val); END"
    expect:
      affected_rows: 0

  - name: "DELETE row 901, BEFORE DELETE trigger logs OLD"
    sql: "DELETE FROM trigger_test WHERE id = 901"
    expect:
      affected_rows: 1

  - name: "DELETE row 902, BEFORE DELETE trigger logs OLD"
    sql: "DELETE FROM trigger_test WHERE id = 902"
    expect:
      affected_rows: 1

  - name: "Verify BEFORE DELETE trigger logged OLD values for both rows"
    sql: "SELECT id, action, old_val FROM trigger_log WHERE action = 'before_delete' ORDER BY id"
    expect:
      rows: 2
      data:
        - { id: 901, action: "before_delete", old_val: 20 }
        - { id: 902, action: "before_delete", old_val: 30 }

  - name: "Verify remaining row was not deleted"
    sql: "SELECT COUNT(*) AS cnt FROM trigger_test WHERE id = 900"
    expect:
      data:
        - cnt: 1

  - name: "DROP BEFORE DELETE logging trigger"
    sql: "DROP TRIGGER IF EXISTS bd_log_old"
    expect:
      affected_rows: 0

  # BEFORE DELETE trigger with conditional logic (IF)

  - name: "Clean up for conditional BEFORE DELETE"
    sql: "DELETE FROM trigger_test"
    expect:
      affected_rows_any: true

  - name: "Insert rows with mixed val for conditional delete"
    sql: "INSERT INTO trigger_test (id, val, name) VALUES (910, 5, 'low'), (911, 50, 'high'), (912, 3, 'low2')"
    expect:
      affected_rows: 3

  - name: "CREATE BEFORE DELETE trigger with IF that logs high-val deletes"
    sql: "CREATE TRIGGER bd_cond BEFORE DELETE ON trigger_test FOR EACH ROW BEGIN IF OLD.val > 10 THEN INSERT INTO trigger_log (id, action, old_val) VALUES (OLD.id, 'highval_del', OLD.val); END IF; END"
    expect:
      affected_rows: 0

  - name: "Clear trigger_log for conditional delete test"
    sql: "DELETE FROM trigger_log"
    expect:
      affected_rows_any: true

  - name: "DELETE row with val <= 10 proceeds normally"
    sql: "DELETE FROM trigger_test WHERE id = 910"
    expect:
      affected_rows: 1

  - name: "DELETE row with val > 10 deletes and logs"
    sql: "DELETE FROM trigger_test WHERE id = 911"
    expect:
      affected_rows: 1

  - name: "Verify log entry for high-val delete"
    sql: "SELECT id, action, old_val FROM trigger_log WHERE action = 'highval_del'"
    expect:
      rows: 1
      data:
        - { id: 911, action: "highval_del", old_val: 50 }

  - name: "Verify low-val delete did not log"
    sql: "SELECT COUNT(*) AS cnt FROM trigger_log WHERE id = 910"
    expect:
      data:
        - cnt: 0

  - name: "DROP conditional BEFORE DELETE trigger"
    sql: "DROP TRIGGER IF EXISTS bd_cond"
    expect:
      affected_rows: 0

  # =====================================================
  # AFTER UPDATE trigger tests (covers ExecuteTriggers AfterUpdate branch)
  # =====================================================

  - name: "Clean up for AFTER UPDATE trigger test"
    sql: "DELETE FROM trigger_test"
    expect:
      affected_rows_any: true

  - name: "Clear trigger_log for AFTER UPDATE test"
    sql: "DELETE FROM trigger_log"
    expect:
      affected_rows_any: true

  - name: "Insert rows for AFTER UPDATE trigger"
    sql: "INSERT INTO trigger_test (id, val, name) VALUES (950, 100, 'upd1'), (951, 200, 'upd2')"
    expect:
      affected_rows: 2

  - name: "CREATE AFTER UPDATE trigger that logs changes"
    sql: "CREATE TRIGGER au_log AFTER UPDATE ON trigger_test FOR EACH ROW BEGIN INSERT INTO trigger_log (id, action, old_val, new_val) VALUES (OLD.id, 'after_update', OLD.val, NEW.val); END"
    expect:
      affected_rows: 0

  - name: "UPDATE single row fires AFTER UPDATE"
    sql: "UPDATE trigger_test SET val = 150 WHERE id = 950"
    expect:
      affected_rows: 1

  - name: "Verify AFTER UPDATE logged the change"
    sql: "SELECT id, action, old_val, new_val FROM trigger_log WHERE id = 950"
    expect:
      rows: 1
      data:
        - { id: 950, action: "after_update", old_val: 100, new_val: 150 }

  - name: "UPDATE multiple rows fires AFTER UPDATE for each"
    sql: "UPDATE trigger_test SET val = val + 1"
    expect:
      affected_rows: 2

  - name: "Verify AFTER UPDATE logged both changes"
    sql: "SELECT COUNT(*) AS cnt FROM trigger_log WHERE action = 'after_update'"
    expect:
      data:
        - cnt: 3

  - name: "DROP AFTER UPDATE trigger"
    sql: "DROP TRIGGER IF EXISTS au_log"
    expect:
      affected_rows: 0

  # =====================================================
  # SHOW TRIGGERS test
  # =====================================================

  - name: "Clean up triggers before SHOW test"
    sql: "DELETE FROM trigger_test"
    expect:
      affected_rows_any: true

  - name: "CREATE trigger for SHOW TRIGGERS test"
    sql: "CREATE TRIGGER show_test_bi BEFORE INSERT ON trigger_test FOR EACH ROW SET NEW.val = 42"
    expect:
      affected_rows: 0

  - name: "SHOW TRIGGERS returns at least one trigger"
    sql: "SHOW TRIGGERS"
    expect:
      min_rows: 1

  - name: "DROP SHOW test trigger"
    sql: "DROP TRIGGER IF EXISTS show_test_bi"
    expect:
      affected_rows: 0

  # =====================================================
  # Multi-row INSERT with BEFORE INSERT trigger
  # =====================================================

  - name: "Clean up for multi-row BEFORE INSERT"
    sql: "DELETE FROM trigger_test"
    expect:
      affected_rows_any: true

  - name: "CREATE BEFORE INSERT trigger for multi-row test"
    sql: "CREATE TRIGGER multi_bi BEFORE INSERT ON trigger_test FOR EACH ROW SET NEW.val = NEW.val * 2"
    expect:
      affected_rows: 0

  - name: "Multi-row INSERT all modified by BEFORE INSERT trigger"
    sql: "INSERT INTO trigger_test (id, val, name) VALUES (1, 5, 'a'), (2, 10, 'b'), (3, 15, 'c'), (4, 20, 'd')"
    expect:
      affected_rows: 4

  - name: "Verify all rows doubled by BEFORE INSERT trigger"
    sql: "SELECT id, val FROM trigger_test ORDER BY id"
    expect:
      rows: 4
      data:
        - { id: 1, val: 10 }
        - { id: 2, val: 20 }
        - { id: 3, val: 30 }
        - { id: 4, val: 40 }

  - name: "DROP multi-row BEFORE INSERT trigger"
    sql: "DROP TRIGGER IF EXISTS multi_bi"
    expect:
      affected_rows: 0

  # =====================================================
  # Multi-row DELETE with BEFORE DELETE trigger
  # =====================================================

  - name: "CREATE BEFORE DELETE trigger for multi-row delete test"
    sql: "CREATE TRIGGER multi_bd BEFORE DELETE ON trigger_test FOR EACH ROW BEGIN INSERT INTO trigger_log (id, action, old_val) VALUES (OLD.id, 'multi_del', OLD.val); END"
    expect:
      affected_rows: 0

  - name: "Clear trigger_log for multi-row delete"
    sql: "DELETE FROM trigger_log"
    expect:
      affected_rows_any: true

  - name: "DELETE multiple rows fires BEFORE DELETE for each"
    sql: "DELETE FROM trigger_test WHERE val >= 30"
    expect:
      affected_rows: 2

  - name: "Verify BEFORE DELETE logged each deleted row"
    sql: "SELECT id, old_val FROM trigger_log WHERE action = 'multi_del' ORDER BY id"
    expect:
      rows: 2
      data:
        - { id: 3, old_val: 30 }
        - { id: 4, old_val: 40 }

  - name: "Verify remaining rows not deleted"
    sql: "SELECT COUNT(*) AS cnt FROM trigger_test"
    expect:
      data:
        - cnt: 2

  - name: "DROP multi-row BEFORE DELETE trigger"
    sql: "DROP TRIGGER IF EXISTS multi_bd"
    expect:
      affected_rows: 0

  # =====================================================
  # AFTER DELETE trigger (covers ExecuteTriggers AfterDelete branch)
  # =====================================================

  - name: "Clean up for AFTER DELETE with OLD access"
    sql: "DELETE FROM trigger_test"
    expect:
      affected_rows_any: true

  - name: "Clear trigger_log for AFTER DELETE test"
    sql: "DELETE FROM trigger_log"
    expect:
      affected_rows_any: true

  - name: "Insert rows for AFTER DELETE test"
    sql: "INSERT INTO trigger_test (id, val, name) VALUES (1000, 77, 'ad_test1'), (1001, 88, 'ad_test2')"
    expect:
      affected_rows: 2

  - name: "CREATE AFTER DELETE trigger accessing OLD columns"
    sql: "CREATE TRIGGER ad_old_access AFTER DELETE ON trigger_test FOR EACH ROW BEGIN INSERT INTO trigger_log (id, action, old_val) VALUES (OLD.id, 'after_del_old', OLD.val); END"
    expect:
      affected_rows: 0

  - name: "DELETE fires AFTER DELETE with OLD access"
    sql: "DELETE FROM trigger_test WHERE id = 1000"
    expect:
      affected_rows: 1

  - name: "Verify AFTER DELETE logged OLD values correctly"
    sql: "SELECT id, action, old_val FROM trigger_log WHERE action = 'after_del_old'"
    expect:
      rows: 1
      data:
        - { id: 1000, action: "after_del_old", old_val: 77 }

  - name: "DELETE remaining row fires AFTER DELETE again"
    sql: "DELETE FROM trigger_test WHERE id = 1001"
    expect:
      affected_rows: 1

  - name: "Verify both AFTER DELETE log entries"
    sql: "SELECT COUNT(*) AS cnt FROM trigger_log WHERE action = 'after_del_old'"
    expect:
      data:
        - cnt: 2

  - name: "DROP AFTER DELETE OLD access trigger"
    sql: "DROP TRIGGER IF EXISTS ad_old_access"
    expect:
      affected_rows: 0

  # =====================================================
  # Trigger with NULL values in OLD/NEW dicts
  # =====================================================

  - name: "Clean up for NULL value trigger test"
    sql: "DELETE FROM trigger_test"
    expect:
      affected_rows_any: true

  - name: "Insert row with NULL values"
    sql: "INSERT INTO trigger_test (id, val, name) VALUES (1100, NULL, NULL)"
    expect:
      affected_rows: 1

  - name: "CREATE BEFORE UPDATE trigger that handles NULLs"
    sql: "CREATE TRIGGER null_upd BEFORE UPDATE ON trigger_test FOR EACH ROW BEGIN IF NEW.val IS NULL THEN SET NEW.val = 0; END IF; END"
    expect:
      affected_rows: 0

  - name: "UPDATE row with NULL val, trigger converts to 0"
    sql: "UPDATE trigger_test SET name = 'updated' WHERE id = 1100"
    expect:
      affected_rows: 1

  - name: "Verify NULL val converted to 0 by trigger"
    sql: "SELECT id, val, name FROM trigger_test WHERE id = 1100"
    expect:
      rows: 1
      data:
        - { id: 1100, val: 0, name: "updated" }

  - name: "DROP NULL handling trigger"
    sql: "DROP TRIGGER IF EXISTS null_upd"
    expect:
      affected_rows: 0

  # =====================================================
  # BEFORE INSERT trigger that sets val to NULL
  # =====================================================

  - name: "Clean up for set-NULL trigger test"
    sql: "DELETE FROM trigger_test"
    expect:
      affected_rows_any: true

  - name: "CREATE BEFORE INSERT trigger that NULLifies val"
    sql: "CREATE TRIGGER null_bi BEFORE INSERT ON trigger_test FOR EACH ROW SET NEW.val = NULL"
    expect:
      affected_rows: 0

  - name: "INSERT with trigger that sets val to NULL"
    sql: "INSERT INTO trigger_test (id, val, name) VALUES (1200, 999, 'nullified')"
    expect:
      affected_rows: 1

  - name: "Verify trigger set val to NULL"
    sql: "SELECT id, val, name FROM trigger_test WHERE id = 1200"
    expect:
      rows: 1
      data:
        - { id: 1200, val: null, name: "nullified" }

  - name: "DROP NULL-setting trigger"
    sql: "DROP TRIGGER IF EXISTS null_bi"
    expect:
      affected_rows: 0

  # =====================================================
  # Multiple triggers on same event (execution order)
  # =====================================================

  - name: "Clean up for multiple triggers test"
    sql: "DELETE FROM trigger_test"
    expect:
      affected_rows_any: true

  - name: "CREATE first BEFORE INSERT trigger (adds 100)"
    sql: "CREATE TRIGGER multi1_bi BEFORE INSERT ON trigger_test FOR EACH ROW SET NEW.val = NEW.val + 100"
    expect:
      affected_rows: 0

  - name: "CREATE second BEFORE INSERT trigger (doubles)"
    sql: "CREATE TRIGGER multi2_bi BEFORE INSERT ON trigger_test FOR EACH ROW SET NEW.val = NEW.val * 2"
    expect:
      affected_rows: 0

  - name: "INSERT fires both triggers sequentially"
    sql: "INSERT INTO trigger_test (id, val, name) VALUES (1300, 5, 'multi_trigger')"
    expect:
      affected_rows: 1

  - name: "Verify both triggers applied (5+100=105, 105*2=210)"
    sql: "SELECT val FROM trigger_test WHERE id = 1300"
    expect:
      rows: 1
      data:
        - val: 210

  - name: "DROP first multi trigger"
    sql: "DROP TRIGGER IF EXISTS multi1_bi"
    expect:
      affected_rows: 0

  - name: "DROP second multi trigger"
    sql: "DROP TRIGGER IF EXISTS multi2_bi"
    expect:
      affected_rows: 0

  # =====================================================
  # BEFORE UPDATE trigger with multi-row UPDATE
  # =====================================================

  - name: "Clean up for multi-row BEFORE UPDATE"
    sql: "DELETE FROM trigger_test"
    expect:
      affected_rows_any: true

  - name: "Insert rows for multi-row BEFORE UPDATE"
    sql: "INSERT INTO trigger_test (id, val, name) VALUES (1400, 10, 'mr1'), (1401, 20, 'mr2'), (1402, 30, 'mr3')"
    expect:
      affected_rows: 3

  - name: "CREATE BEFORE UPDATE trigger for multi-row"
    sql: "CREATE TRIGGER mr_bu BEFORE UPDATE ON trigger_test FOR EACH ROW SET NEW.val = OLD.val + NEW.val"
    expect:
      affected_rows: 0

  - name: "Multi-row UPDATE fires BEFORE UPDATE for each row"
    sql: "UPDATE trigger_test SET val = 5"
    expect:
      affected_rows: 3

  - name: "Verify trigger added OLD.val + NEW.val for each row"
    sql: "SELECT id, val FROM trigger_test ORDER BY id"
    expect:
      rows: 3
      data:
        - { id: 1400, val: 15 }
        - { id: 1401, val: 25 }
        - { id: 1402, val: 35 }

  - name: "DROP multi-row BEFORE UPDATE trigger"
    sql: "DROP TRIGGER IF EXISTS mr_bu"
    expect:
      affected_rows: 0

  # =====================================================
  # BEFORE DELETE with AFTER DELETE on same table
  # =====================================================

  - name: "Clean up for combined DELETE triggers"
    sql: "DELETE FROM trigger_test"
    expect:
      affected_rows_any: true

  - name: "Clear trigger_log for combined DELETE"
    sql: "DELETE FROM trigger_log"
    expect:
      affected_rows_any: true

  - name: "Insert rows for combined DELETE triggers"
    sql: "INSERT INTO trigger_test (id, val, name) VALUES (1500, 55, 'combo_del')"
    expect:
      affected_rows: 1

  - name: "CREATE BEFORE DELETE trigger for combined test"
    sql: "CREATE TRIGGER combo_bd BEFORE DELETE ON trigger_test FOR EACH ROW BEGIN INSERT INTO trigger_log (id, action, old_val) VALUES (OLD.id, 'combo_before', OLD.val); END"
    expect:
      affected_rows: 0

  - name: "CREATE AFTER DELETE trigger for combined test"
    sql: "CREATE TRIGGER combo_ad AFTER DELETE ON trigger_test FOR EACH ROW BEGIN INSERT INTO trigger_log (id, action, old_val) VALUES (OLD.id, 'combo_after', OLD.val); END"
    expect:
      affected_rows: 0

  - name: "DELETE fires both BEFORE and AFTER DELETE"
    sql: "DELETE FROM trigger_test WHERE id = 1500"
    expect:
      affected_rows: 1

  - name: "Verify BEFORE DELETE logged"
    sql: "SELECT COUNT(*) AS cnt FROM trigger_log WHERE action = 'combo_before' AND id = 1500"
    expect:
      data:
        - cnt: 1

  - name: "Verify AFTER DELETE logged"
    sql: "SELECT COUNT(*) AS cnt FROM trigger_log WHERE action = 'combo_after' AND id = 1500"
    expect:
      data:
        - cnt: 1

  - name: "DROP combined BEFORE DELETE trigger"
    sql: "DROP TRIGGER IF EXISTS combo_bd"
    expect:
      affected_rows: 0

  - name: "DROP combined AFTER DELETE trigger"
    sql: "DROP TRIGGER IF EXISTS combo_ad"
    expect:
      affected_rows: 0

  # =====================================================
  # BEFORE INSERT + AFTER INSERT combined on same table
  # =====================================================

  - name: "Clean up for combined INSERT triggers"
    sql: "DELETE FROM trigger_test"
    expect:
      affected_rows_any: true

  - name: "Clear trigger_log for combined INSERT"
    sql: "DELETE FROM trigger_log"
    expect:
      affected_rows_any: true

  - name: "CREATE BEFORE INSERT that doubles val"
    sql: "CREATE TRIGGER combo_bi BEFORE INSERT ON trigger_test FOR EACH ROW SET NEW.val = NEW.val * 2"
    expect:
      affected_rows: 0

  - name: "CREATE AFTER INSERT that logs the final value"
    sql: "CREATE TRIGGER combo_ai AFTER INSERT ON trigger_test FOR EACH ROW BEGIN INSERT INTO trigger_log (id, action, new_val) VALUES (NEW.id, 'combo_after_ins', NEW.val); END"
    expect:
      affected_rows: 0

  - name: "INSERT fires BEFORE then AFTER trigger"
    sql: "INSERT INTO trigger_test (id, val, name) VALUES (1600, 25, 'combo_ins')"
    expect:
      affected_rows: 1

  - name: "Verify BEFORE INSERT doubled the value"
    sql: "SELECT val FROM trigger_test WHERE id = 1600"
    expect:
      data:
        - val: 50

  - name: "Verify AFTER INSERT logged the doubled value"
    sql: "SELECT new_val FROM trigger_log WHERE action = 'combo_after_ins' AND id = 1600"
    expect:
      rows: 1
      data:
        - new_val: 50

  - name: "DROP combined BEFORE INSERT trigger"
    sql: "DROP TRIGGER IF EXISTS combo_bi"
    expect:
      affected_rows: 0

  - name: "DROP combined AFTER INSERT trigger"
    sql: "DROP TRIGGER IF EXISTS combo_ai"
    expect:
      affected_rows: 0

  # =====================================================
  # BEFORE UPDATE + AFTER UPDATE combined on same table
  # =====================================================

  - name: "Clean up for combined UPDATE triggers"
    sql: "DELETE FROM trigger_test"
    expect:
      affected_rows_any: true

  - name: "Clear trigger_log for combined UPDATE"
    sql: "DELETE FROM trigger_log"
    expect:
      affected_rows_any: true

  - name: "Insert row for combined UPDATE triggers"
    sql: "INSERT INTO trigger_test (id, val, name) VALUES (1700, 10, 'combo_upd')"
    expect:
      affected_rows: 1

  - name: "CREATE BEFORE UPDATE that triples val"
    sql: "CREATE TRIGGER combo_bu BEFORE UPDATE ON trigger_test FOR EACH ROW SET NEW.val = NEW.val * 3"
    expect:
      affected_rows: 0

  - name: "CREATE AFTER UPDATE that logs OLD and NEW"
    sql: "CREATE TRIGGER combo_au AFTER UPDATE ON trigger_test FOR EACH ROW BEGIN INSERT INTO trigger_log (id, action, old_val, new_val) VALUES (OLD.id, 'combo_after_upd', OLD.val, NEW.val); END"
    expect:
      affected_rows: 0

  - name: "UPDATE fires BEFORE then AFTER UPDATE"
    sql: "UPDATE trigger_test SET val = 7 WHERE id = 1700"
    expect:
      affected_rows: 1

  - name: "Verify BEFORE UPDATE tripled the value"
    sql: "SELECT val FROM trigger_test WHERE id = 1700"
    expect:
      data:
        - val: 21

  - name: "Verify AFTER UPDATE logged OLD=10, NEW=21"
    sql: "SELECT old_val, new_val FROM trigger_log WHERE action = 'combo_after_upd' AND id = 1700"
    expect:
      rows: 1
      data:
        - { old_val: 10, new_val: 21 }

  - name: "DROP combined BEFORE UPDATE trigger"
    sql: "DROP TRIGGER IF EXISTS combo_bu"
    expect:
      affected_rows: 0

  - name: "DROP combined AFTER UPDATE trigger"
    sql: "DROP TRIGGER IF EXISTS combo_au"
    expect:
      affected_rows: 0

  # =====================================================
  # DELETE with no matching rows (trigger should NOT fire)
  # =====================================================

  - name: "Clean up for no-match DELETE test"
    sql: "DELETE FROM trigger_test"
    expect:
      affected_rows_any: true

  - name: "Clear trigger_log for no-match test"
    sql: "DELETE FROM trigger_log"
    expect:
      affected_rows_any: true

  - name: "CREATE BEFORE DELETE trigger for no-match test"
    sql: "CREATE TRIGGER nomatch_bd BEFORE DELETE ON trigger_test FOR EACH ROW BEGIN INSERT INTO trigger_log (id, action, old_val) VALUES (OLD.id, 'nomatch', OLD.val); END"
    expect:
      affected_rows: 0

  - name: "DELETE with no matching rows does not fire trigger"
    sql: "DELETE FROM trigger_test WHERE id = 99999"
    expect:
      affected_rows: 0

  - name: "Verify trigger did NOT fire"
    sql: "SELECT COUNT(*) AS cnt FROM trigger_log WHERE action = 'nomatch'"
    expect:
      data:
        - cnt: 0

  - name: "DROP no-match BEFORE DELETE trigger"
    sql: "DROP TRIGGER IF EXISTS nomatch_bd"
    expect:
      affected_rows: 0

  # =====================================================
  # UPDATE with no matching rows (trigger should NOT fire)
  # =====================================================

  - name: "Clear trigger_log for no-match UPDATE test"
    sql: "DELETE FROM trigger_log"
    expect:
      affected_rows_any: true

  - name: "CREATE AFTER UPDATE trigger for no-match test"
    sql: "CREATE TRIGGER nomatch_au AFTER UPDATE ON trigger_test FOR EACH ROW BEGIN INSERT INTO trigger_log (id, action, new_val) VALUES (NEW.id, 'nomatch_upd', NEW.val); END"
    expect:
      affected_rows: 0

  - name: "UPDATE with no matching rows does not fire trigger"
    sql: "UPDATE trigger_test SET val = 999 WHERE id = 99999"
    expect:
      affected_rows: 0

  - name: "Verify AFTER UPDATE trigger did NOT fire"
    sql: "SELECT COUNT(*) AS cnt FROM trigger_log WHERE action = 'nomatch_upd'"
    expect:
      data:
        - cnt: 0

  - name: "DROP no-match AFTER UPDATE trigger"
    sql: "DROP TRIGGER IF EXISTS nomatch_au"
    expect:
      affected_rows: 0

  # =====================================================
  # Error cases: DROP TRIGGER that doesn't exist
  # =====================================================

  - name: "DROP TRIGGER without IF EXISTS on non-existent trigger"
    sql: "DROP TRIGGER nonexistent_trigger_xyz"
    expect:
      error: true

  # =====================================================
  # Trigger on NOT NULL column: BEFORE INSERT trigger
  # that violates constraint should error
  # =====================================================

  - name: "Create table with NOT NULL for trigger error test"
    sql: "CREATE TABLE trigger_nn (id INT, val INT NOT NULL)"
    expect:
      affected_rows: 0

  - name: "CREATE BEFORE INSERT trigger that sets NOT NULL col to NULL"
    sql: "CREATE TRIGGER nn_violate BEFORE INSERT ON trigger_nn FOR EACH ROW SET NEW.val = NULL"
    expect:
      affected_rows: 0

  - name: "INSERT into NOT NULL col where trigger sets NULL should error"
    sql: "INSERT INTO trigger_nn (id, val) VALUES (1, 42)"
    expect:
      error: true

  - name: "DROP NOT NULL violation trigger"
    sql: "DROP TRIGGER IF EXISTS nn_violate"
    expect:
      affected_rows: 0

  - name: "Drop NOT NULL test table"
    sql: "DROP TABLE IF EXISTS trigger_nn"
    expect:
      affected_rows: 0

  # =====================================================
  # Trigger on table with BEFORE INSERT + INSERT IGNORE
  # where trigger modifies value but PK collision
  # =====================================================

  - name: "Create PK table for INSERT IGNORE multi-trigger test"
    sql: "CREATE TABLE trigger_ign2 (id INT PRIMARY KEY, val INT, tag VARCHAR(20))"
    expect:
      affected_rows: 0

  - name: "CREATE BEFORE INSERT trigger that adds 500"
    sql: "CREATE TRIGGER ign2_bi BEFORE INSERT ON trigger_ign2 FOR EACH ROW SET NEW.val = NEW.val + 500"
    expect:
      affected_rows: 0

  - name: "Insert initial rows"
    sql: "INSERT INTO trigger_ign2 (id, val, tag) VALUES (1, 10, 'first'), (2, 20, 'second')"
    expect:
      affected_rows: 2

  - name: "Verify initial rows have trigger-modified values"
    sql: "SELECT id, val FROM trigger_ign2 ORDER BY id"
    expect:
      rows: 2
      data:
        - { id: 1, val: 510 }
        - { id: 2, val: 520 }

  - name: "INSERT IGNORE batch with some collisions"
    sql: "INSERT IGNORE INTO trigger_ign2 (id, val, tag) VALUES (2, 30, 'dup'), (3, 40, 'new1'), (1, 50, 'dup2'), (4, 60, 'new2')"
    expect:
      affected_rows: 2

  - name: "Verify collisions skipped, new rows have trigger values"
    sql: "SELECT id, val, tag FROM trigger_ign2 ORDER BY id"
    expect:
      rows: 4
      data:
        - { id: 1, val: 510, tag: "first" }
        - { id: 2, val: 520, tag: "second" }
        - { id: 3, val: 540, tag: "new1" }
        - { id: 4, val: 560, tag: "new2" }

  - name: "DROP INSERT IGNORE multi trigger"
    sql: "DROP TRIGGER IF EXISTS ign2_bi"
    expect:
      affected_rows: 0

  - name: "Drop INSERT IGNORE multi test table"
    sql: "DROP TABLE IF EXISTS trigger_ign2"
    expect:
      affected_rows: 0

  # =====================================================
  # Trigger body: INSERT...SELECT (cross-table copy)
  # =====================================================

  - name: "Clean up for INSERT...SELECT trigger test"
    sql: "DELETE FROM trigger_test"
    expect:
      affected_rows_any: true

  - name: "Clear trigger_log for INSERT...SELECT test"
    sql: "DELETE FROM trigger_log"
    expect:
      affected_rows_any: true

  - name: "Insert source rows for INSERT...SELECT trigger"
    sql: "INSERT INTO trigger_test (id, val, name) VALUES (2000, 42, 'src1'), (2001, 99, 'src2')"
    expect:
      affected_rows: 2

  - name: "CREATE AFTER INSERT trigger with INSERT...SELECT"
    sql: "CREATE TRIGGER ins_sel_ai AFTER INSERT ON trigger_test FOR EACH ROW BEGIN INSERT INTO trigger_log (id, action, new_val) SELECT NEW.id, 'ins_select', NEW.val; END"
    expect:
      affected_rows: 0

  - name: "INSERT fires trigger with INSERT...SELECT body"
    sql: "INSERT INTO trigger_test (id, val, name) VALUES (2002, 77, 'trigger_ins_sel')"
    expect:
      affected_rows: 1

  - name: "Verify INSERT...SELECT trigger wrote to log"
    sql: "SELECT id, action, new_val FROM trigger_log WHERE id = 2002"
    expect:
      rows: 1
      data:
        - { id: 2002, action: "ins_select", new_val: 77 }

  - name: "DROP INSERT...SELECT trigger"
    sql: "DROP TRIGGER IF EXISTS ins_sel_ai"
    expect:
      affected_rows: 0

  # =====================================================
  # Trigger body: SET @var (session variable, ignored)
  # =====================================================

  - name: "Clean up for SET @var trigger test"
    sql: "DELETE FROM trigger_test"
    expect:
      affected_rows_any: true

  - name: "CREATE trigger with SET @var (should parse and be ignored)"
    sql: "CREATE TRIGGER setvar_ai AFTER INSERT ON trigger_test FOR EACH ROW BEGIN SET @last_id = NEW.id; INSERT INTO trigger_log (id, action, new_val) VALUES (NEW.id, 'setvar', NEW.val); END"
    expect:
      affected_rows: 0

  - name: "Clear trigger_log for SET @var test"
    sql: "DELETE FROM trigger_log"
    expect:
      affected_rows_any: true

  - name: "INSERT fires trigger with SET @var and INSERT"
    sql: "INSERT INTO trigger_test (id, val, name) VALUES (2100, 33, 'setvar_test')"
    expect:
      affected_rows: 1

  - name: "Verify SET @var trigger executed the INSERT (SET @var ignored)"
    sql: "SELECT id, action, new_val FROM trigger_log WHERE id = 2100"
    expect:
      rows: 1
      data:
        - { id: 2100, action: "setvar", new_val: 33 }

  - name: "DROP SET @var trigger"
    sql: "DROP TRIGGER IF EXISTS setvar_ai"
    expect:
      affected_rows: 0

  # =====================================================
  # Trigger body: INSERT IGNORE INTO (duplicate handling)
  # =====================================================

  - name: "Create PK table for INSERT IGNORE trigger body test"
    sql: "CREATE TABLE trigger_ign_body (id INT PRIMARY KEY, val INT)"
    expect:
      affected_rows: 0

  - name: "Insert base row for trigger INSERT IGNORE test"
    sql: "INSERT INTO trigger_ign_body (id, val) VALUES (1, 100)"
    expect:
      affected_rows: 1

  - name: "Clean up trigger_test for INSERT IGNORE body test"
    sql: "DELETE FROM trigger_test"
    expect:
      affected_rows_any: true

  - name: "CREATE AFTER INSERT trigger with INSERT IGNORE body"
    sql: "CREATE TRIGGER ign_body_ai AFTER INSERT ON trigger_test FOR EACH ROW BEGIN INSERT IGNORE INTO trigger_ign_body (id, val) VALUES (NEW.id, NEW.val); END"
    expect:
      affected_rows: 0

  - name: "INSERT that triggers INSERT IGNORE with no collision"
    sql: "INSERT INTO trigger_test (id, val, name) VALUES (2, 200, 'no_dup')"
    expect:
      affected_rows: 1

  - name: "Verify trigger INSERT IGNORE created row (no collision)"
    sql: "SELECT id, val FROM trigger_ign_body WHERE id = 2"
    expect:
      rows: 1
      data:
        - { id: 2, val: 200 }

  - name: "INSERT that triggers INSERT IGNORE with PK collision"
    sql: "INSERT INTO trigger_test (id, val, name) VALUES (1, 999, 'has_dup')"
    expect:
      affected_rows: 1

  - name: "Verify trigger INSERT IGNORE skipped duplicate (original unchanged)"
    sql: "SELECT id, val FROM trigger_ign_body WHERE id = 1"
    expect:
      rows: 1
      data:
        - { id: 1, val: 100 }

  - name: "DROP INSERT IGNORE body trigger"
    sql: "DROP TRIGGER IF EXISTS ign_body_ai"
    expect:
      affected_rows: 0

  - name: "Drop INSERT IGNORE body test table"
    sql: "DROP TABLE IF EXISTS trigger_ign_body"
    expect:
      affected_rows: 0

  # =====================================================
  # Trigger body: UPDATE statement
  # =====================================================

  - name: "Clean up for UPDATE in trigger body test"
    sql: "DELETE FROM trigger_test"
    expect:
      affected_rows_any: true

  - name: "Create counter table for UPDATE trigger body"
    sql: "CREATE TABLE trigger_counter (name VARCHAR(50), cnt INT)"
    expect:
      affected_rows: 0

  - name: "Insert initial counter"
    sql: "INSERT INTO trigger_counter (name, cnt) VALUES ('inserts', 0)"
    expect:
      affected_rows: 1

  - name: "CREATE AFTER INSERT trigger with UPDATE body"
    sql: "CREATE TRIGGER upd_body_ai AFTER INSERT ON trigger_test FOR EACH ROW BEGIN UPDATE trigger_counter SET cnt = cnt + 1 WHERE name = 'inserts'; END"
    expect:
      affected_rows: 0

  - name: "INSERT fires trigger that UPDATEs counter"
    sql: "INSERT INTO trigger_test (id, val, name) VALUES (2200, 1, 'cnt1')"
    expect:
      affected_rows: 1

  - name: "Second INSERT fires trigger again"
    sql: "INSERT INTO trigger_test (id, val, name) VALUES (2201, 2, 'cnt2')"
    expect:
      affected_rows: 1

  - name: "Verify UPDATE in trigger body incremented counter"
    sql: "SELECT cnt FROM trigger_counter WHERE name = 'inserts'"
    expect:
      data:
        - cnt: 2

  - name: "DROP UPDATE body trigger"
    sql: "DROP TRIGGER IF EXISTS upd_body_ai"
    expect:
      affected_rows: 0

  - name: "Drop counter table"
    sql: "DROP TABLE IF EXISTS trigger_counter"
    expect:
      affected_rows: 0

  # =====================================================
  # Trigger body: DELETE statement
  # =====================================================

  - name: "Clean up for DELETE in trigger body test"
    sql: "DELETE FROM trigger_test"
    expect:
      affected_rows_any: true

  - name: "Create archive table for DELETE trigger body"
    sql: "CREATE TABLE trigger_archive (id INT, val INT, archived VARCHAR(10))"
    expect:
      affected_rows: 0

  - name: "Insert rows into archive"
    sql: "INSERT INTO trigger_archive (id, val, archived) VALUES (3000, 10, 'yes'), (3001, 20, 'yes'), (3002, 30, 'no')"
    expect:
      affected_rows: 3

  - name: "CREATE AFTER INSERT trigger with DELETE body"
    sql: "CREATE TRIGGER del_body_ai AFTER INSERT ON trigger_test FOR EACH ROW BEGIN DELETE FROM trigger_archive WHERE id = NEW.id; END"
    expect:
      affected_rows: 0

  - name: "INSERT fires trigger that DELETEs from archive"
    sql: "INSERT INTO trigger_test (id, val, name) VALUES (3000, 1, 'del_test')"
    expect:
      affected_rows: 1

  - name: "Verify DELETE in trigger body removed archive row"
    sql: "SELECT COUNT(*) AS cnt FROM trigger_archive WHERE id = 3000"
    expect:
      data:
        - cnt: 0

  - name: "Verify other archive rows untouched"
    sql: "SELECT COUNT(*) AS cnt FROM trigger_archive"
    expect:
      data:
        - cnt: 2

  - name: "DROP DELETE body trigger"
    sql: "DROP TRIGGER IF EXISTS del_body_ai"
    expect:
      affected_rows: 0

  - name: "Drop archive table"
    sql: "DROP TABLE IF EXISTS trigger_archive"
    expect:
      affected_rows: 0
