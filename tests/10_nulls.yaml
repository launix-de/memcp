# NULLs and COALESCE Test Suite

metadata:
  version: "1.0"
  description: "NULL literal handling and COALESCE; COUNT with NULLs"

setup:
  - sql: "DROP TABLE IF EXISTS null_test"
  - sql: "CREATE TABLE null_test (id INT, name VARCHAR(50))"
  - sql: "INSERT INTO null_test (id, name) VALUES (1, 'alpha'), (2, NULL), (3, NULL)"

test_cases:
  - name: "NULL literal"
    sql: "SELECT NULL AS v"
    expect:
      rows: 1

  - name: "COALESCE picks first non-null"
    sql: "SELECT COALESCE(NULL, 'x', 'y') AS v"
    expect:
      rows: 1
      data:
        - v: "x"

  - name: "COUNT ignores NULL values"
    sql: "SELECT COUNT(name) AS c FROM null_test"
    expect:
      rows: 1
      data:
        - c: 1

  - name: "COUNT(*) counts all rows"
    sql: "SELECT COUNT(*) AS c FROM null_test"
    expect:
      rows: 1
      data:
        - c: 3

  # === Extended NULL coverage ===

  - name: "IS NULL filter"
    sql: "SELECT id FROM null_test WHERE name IS NULL ORDER BY id"
    expect:
      rows: 2
      data:
        - id: 2
        - id: 3

  - name: "IS NOT NULL filter"
    sql: "SELECT id FROM null_test WHERE name IS NOT NULL"
    expect:
      rows: 1
      data:
        - id: 1

  - name: "NULL in arithmetic"
    sql: "SELECT id + NULL AS v FROM null_test WHERE id = 1"
    expect:
      rows: 1
      data:
        - v: null

  - name: "NULL string concat"
    sql: "SELECT CONCAT(name, ' suffix') AS v FROM null_test WHERE id = 2"
    expect:
      rows: 1

  - name: "SUM ignores NULL"
    sql: "SELECT SUM(id) AS s FROM null_test"
    expect:
      rows: 1
      data:
        - s: 6

  - name: "MIN on nullable column"
    sql: "SELECT MIN(name) AS m FROM null_test"
    expect:
      rows: 1
      data:
        - m: "alpha"

  - name: "MAX on nullable column"
    sql: "SELECT MAX(name) AS m FROM null_test"
    expect:
      rows: 1
      data:
        - m: "alpha"

  - name: "ORDER BY nullable column ASC"
    sql: "SELECT id FROM null_test ORDER BY name ASC"
    expect:
      rows: 3

  - name: "ORDER BY nullable column DESC"
    sql: "SELECT id FROM null_test ORDER BY name DESC"
    expect:
      rows: 3

  - name: "GROUP BY with NULLs"
    sql: "SELECT name, COUNT(*) AS cnt FROM null_test GROUP BY name ORDER BY name"
    expect:
      rows: 2

  - name: "IFNULL function"
    sql: "SELECT IFNULL(name, 'unknown') AS v FROM null_test WHERE id = 2"
    expect:
      rows: 1
      data:
        - v: "unknown"

  - name: "IFNULL with NULL first arg"
    sql: "SELECT IFNULL(NULL, 'fallback') AS v"
    expect:
      rows: 1
      data:
        - v: "fallback"

  - name: "IFNULL with non-NULL first arg"
    sql: "SELECT IFNULL('present', 'fallback') AS v"
    expect:
      rows: 1
      data:
        - v: "present"

  # === NOT expr IS NULL precedence (MySQL form) ===

  - name: "NOT col IS NULL equals IS NOT NULL"
    sql: "SELECT id FROM null_test WHERE NOT name IS NULL"
    expect:
      rows: 1
      data:
        - id: 1

  - name: "NOT col IS NULL with AND"
    sql: "SELECT id FROM null_test WHERE NOT name IS NULL AND id = 1"
    expect:
      rows: 1
      data:
        - id: 1

  - name: "NOT col IS NULL returns no rows for NULLs"
    sql: "SELECT id FROM null_test WHERE NOT id IS NULL AND name IS NULL ORDER BY id"
    expect:
      rows: 2
      data:
        - id: 2
        - id: 3

  - name: "Double NOT IS NULL"
    sql: "SELECT id FROM null_test WHERE NOT (NOT name IS NULL)"
    expect:
      rows: 2

cleanup:
  - sql: "DROP TABLE IF EXISTS null_test"
