# Subselects in FROM (Derived Tables)

metadata:
  version: "1.0"
  description: "Use SELECT in FROM (basic)"

setup:
  - sql: "DROP TABLE IF EXISTS customers"
  - sql: "DROP TABLE IF EXISTS orders"
  - sql: "CREATE TABLE customers (id INT, name VARCHAR(50))"
  - sql: "CREATE TABLE orders (id INT, customer_id INT)"
  - sql: "INSERT INTO customers (id, name) VALUES (1, 'Alice'), (2, 'Bob')"
  - sql: "INSERT INTO orders (id, customer_id) VALUES (1,1), (2,1), (3,2)"

test_cases:
  - name: "Derived table with filter"
    sql: "SELECT t.a FROM (SELECT 1 AS a) t WHERE t.a = 1"
    expect:
      rows: 1
      data:
        - a: 1

# TODO(memcp): Subselect-in-FROM (derived tables) fails with "Unknown function: <nil>".
# - name: "Join with aggregated subselect"
#   sql: |
#     SELECT c.name, o.cnt
#     FROM customers c
#     JOIN (SELECT customer_id, COUNT(*) AS cnt FROM orders GROUP BY customer_id) o
#       ON c.id = o.customer_id
#     ORDER BY o.cnt DESC
#     LIMIT 1
#   expect:
#     rows: 1
#     data:
#       - name: "Alice"
#         cnt: 2

  # === Scalar subselects in SELECT list ===
  - name: "Scalar subselect in SELECT"
    sql: "SELECT (SELECT 1) AS sub"
    expect:
      rows: 1
      data:
        - sub: 1

  - name: "Multiple scalar subselects in SELECT"
    sql: "SELECT 1 AS a, (SELECT 2) AS b, (SELECT 3) AS c"
    expect:
      rows: 1
      data:
        - a: 1
          b: 2
          c: 3

  - name: "Scalar subselect with CASE WHEN"
    sql: "SELECT (SELECT CASE WHEN TRUE THEN 1 ELSE 0 END) AS t"
    expect:
      rows: 1
      data:
        - t: 1

  - name: "Scalar subselect with unary minus"
    sql: "SELECT (SELECT CASE WHEN FALSE THEN 1 ELSE -(1) END) AS t"
    expect:
      rows: 1
      data:
        - t: -1

  - name: "Scalar subselect with unary minus and space"
    sql: "SELECT (SELECT CASE WHEN FALSE THEN 1 ELSE - (1) END) AS t"
    expect:
      rows: 1
      data:
        - t: -1

  - name: "Unary minus in expression"
    sql: "SELECT -(5) AS t"
    expect:
      rows: 1
      data:
        - t: -5

  - name: "Unary minus with multiplication"
    sql: "SELECT 3 * -(2) AS t"
    expect:
      rows: 1
      data:
        - t: -6

  - name: "UNIX_TIMESTAMP with expression"
    sql: "SELECT UNIX_TIMESTAMP('2025-01-01') AS t"
    expect:
      rows: 1

  - name: "Correlated scalar subselect"
    sql: |
      SELECT c.name,
        (SELECT COUNT(*) FROM orders o WHERE o.customer_id = c.id) AS order_count
      FROM customers c
      ORDER BY c.id
    expect:
      rows: 2
      data:
        - name: "Alice"
          order_count: 2
        - name: "Bob"
          order_count: 1

cleanup:
  - sql: "DROP TABLE IF EXISTS orders"
  - sql: "DROP TABLE IF EXISTS customers"
