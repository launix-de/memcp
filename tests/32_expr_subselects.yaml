# Subselects in expressions (IN/EXISTS/scalar)

metadata:
  version: "1.0"
  description: "IN/EXISTS still rejected; scalar is noncritical until implemented"

setup: []

# TODO: turn error: true into what we expect according to SQL standard
# TODO: also add complex cases with (SELECT FROM )

test_cases:
  - name: "IN subselect simple"
    sql: "SELECT 1 WHERE 1 IN (SELECT 1)"
    expect:
      error: true

  - name: "NOT IN subselect simple"
    sql: "SELECT 1 WHERE 1 NOT IN (SELECT 1)"
    expect:
      error: true

  - name: "EXISTS subselect"
    sql: "SELECT 1 WHERE EXISTS (SELECT 1)"
    expect:
      error: true

  - name: "Scalar subselect in SELECT list"
    noncritical: true
    sql: "SELECT (SELECT 1) AS x"
    expect:
      rows: 1
      data:
        - x: 1

  - name: "Scalar subselect without correlation"
    noncritical: true
    setup:
      - "DROP TABLE IF EXISTS t2"
      - "CREATE TABLE t2 (owner INT, val INT)"
      - "INSERT INTO t2 (owner, val) VALUES (1, 42)"
    sql: "SELECT (SELECT val FROM t2 WHERE owner = 1) AS v"
    expect:
      rows: 1
      data:
        - v: 42
    cleanup:
      - "DROP TABLE IF EXISTS t2"

  - name: "Scalar correlated subselect in SELECT list"
    noncritical: true
    setup:
      - "DROP TABLE IF EXISTS t1"
      - "DROP TABLE IF EXISTS t2"
      - "CREATE TABLE t1 (id INT PRIMARY KEY)"
      - "CREATE TABLE t2 (owner INT, val INT)"
      - "INSERT INTO t1 (id) VALUES (1)"
      - "INSERT INTO t2 (owner, val) VALUES (1, 42)"
    sql: "SELECT (SELECT val FROM t2 WHERE owner = t1.id) AS v FROM t1"
    expect:
      rows: 1
      data:
        - v: 42
    cleanup:
      - "DROP TABLE IF EXISTS t2"
      - "DROP TABLE IF EXISTS t1"

  - name: "IN constant list still supported"
    sql: "SELECT 1 WHERE 1 IN (1,2,3)"
    expect:
      rows: 1

cleanup: []
