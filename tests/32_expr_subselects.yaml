# Subselects in expressions (IN/EXISTS/scalar)

metadata:
  version: "1.0"
  description: "IN/EXISTS still rejected; scalar subselects supported"

setup:
  - sql: "DROP TABLE IF EXISTS t1"
  - sql: "DROP TABLE IF EXISTS t2"
  - sql: "CREATE TABLE t1 (id INT PRIMARY KEY)"
  - sql: "CREATE TABLE t2 (owner INT, val INT)"
  - sql: "INSERT INTO t1 (id) VALUES (4)"
  - sql: "INSERT INTO t2 (owner, val) VALUES (1, 42)"
  - sql: "INSERT INTO t2 (owner, val) VALUES (2, 41)"
  - sql: "INSERT INTO t2 (owner, val) VALUES (2, 42)"
  - sql: "INSERT INTO t2 (owner, val) VALUES (3, 41)"
  - sql: "INSERT INTO t2 (owner, val) VALUES (3, 42)"
  - sql: "INSERT INTO t2 (owner, val) VALUES (4, 55)"

# TODO: turn error: true into what we expect according to SQL standard
# TODO: also add complex cases with (SELECT FROM )

test_cases:
  - name: "IN subselect simple"
    sql: "SELECT 1 WHERE 1 IN (SELECT 1)"
    expect:
      error: true

  - name: "NOT IN subselect simple"
    sql: "SELECT 1 WHERE 1 NOT IN (SELECT 1)"
    expect:
      error: true

  - name: "EXISTS subselect"
    sql: "SELECT 1 WHERE EXISTS (SELECT 1)"
    expect:
      error: true

  - name: "Scalar subselect in SELECT list"
    sql: "SELECT (SELECT 1) AS x"
    expect:
      rows: 1
      data:
        - x: 1

  - name: "Scalar subselect without correlation"
    sql: "SELECT (SELECT val FROM t2 WHERE owner = 1) AS v"
    expect:
      rows: 1
      data:
        - v: 42

  - name: "Scalar subselect ORDER BY LIMIT 1"
    sql: "SELECT (SELECT val FROM t2 WHERE owner = 3 ORDER BY val DESC LIMIT 1) AS v"
    expect:
      rows: 1
      data:
        - v: 42

  - name: "Scalar correlated subselect in SELECT list"
    sql: "SELECT (SELECT val FROM t2 WHERE owner = t1.id) AS v FROM t1"
    expect:
      rows: 1
      data:
        - v: 55

  - name: "Scalar subselect multiple rows errors"
    sql: "SELECT (SELECT val FROM t2 WHERE owner = 2) AS v"
    expect:
      error: true

  - name: "IN constant list still supported"
    sql: "SELECT 1 WHERE 1 IN (1,2,3)"
    expect:
      rows: 1

cleanup:
  - sql: "DROP TABLE IF EXISTS t2"
  - sql: "DROP TABLE IF EXISTS t1"
