# Coverage tests for serialize + json roundtrip via table storage
# Pure Scheme tests (json_encode, base64, hex, serialize, String) moved to lib/test.scm

metadata:
  version: "1.0"
  description: "Serializer and encoding function coverage (SQL integration)"

setup: []

test_cases:

  # ========================================================================
  # Combined: serialize + json roundtrip on table data
  # ========================================================================
  - name: "Create table for roundtrip test"
    sql: "CREATE TABLE ser_test (id INT, data VARCHAR(200))"
    expect:
      rows: 0

  - name: "Insert JSON-encoded data into table"
    scm: |
      (begin
        (insert "memcp-tests" "ser_test" '("id" "data")
          (list
            (list 1 (json_encode '("a" "b" "c")))
            (list 2 (json_encode_assoc '("key" "value" "num" 42)))
            (list 3 (json_encode nil))))
        3)

  - name: "Verify JSON stored in table"
    sql: "SELECT data FROM ser_test WHERE id = 1"
    expect:
      rows: 1
      data:
        - data: "[\"a\",\"b\",\"c\"]"

  - name: "Decode JSON from table via scm"
    scm: |
      (begin
        (set rows (scan "memcp-tests" "ser_test" '("id") (lambda (id) (equal? id 2)) '("data") (lambda (data) data) (lambda (a b) b) nil))
        (set decoded (json_decode rows))
        (get_assoc decoded "key"))
    expect:
      data: ["value"]

  - name: "Drop roundtrip table"
    sql: "DROP TABLE IF EXISTS ser_test"
    expect:
      rows: 0

cleanup: []
