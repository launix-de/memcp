# Storage type coverage test suite
# Exercises StorageFloat, StorageInt, StorageSeq, StorageString, StorageSCMER
# by inserting typed data, forcing compression via SHUTDOWN, and verifying after restart.

metadata:
  version: "1.0"
  description: "Storage type selection and compression coverage"

setup:
  - sql: "DROP TABLE IF EXISTS st_float"
  - sql: "DROP TABLE IF EXISTS st_int"
  - sql: "DROP TABLE IF EXISTS st_seq"
  - sql: "DROP TABLE IF EXISTS st_string"
  - sql: "DROP TABLE IF EXISTS st_mixed"
  - sql: "DROP TABLE IF EXISTS st_seq_edge"
  - sql: "DROP TABLE IF EXISTS st_str_buf"

test_cases:

  # === StorageFloat: columns with only float values ===
  - name: "Create float table"
    sql: "CREATE TABLE st_float (id INT, temperature DOUBLE, ratio FLOAT)"
    expect:
      rows: 0

  - name: "Insert float data (8 rows for compression)"
    sql: |
      INSERT INTO st_float VALUES
        (1, 98.6, 0.5),
        (2, 100.4, 0.75),
        (3, 37.2, 1.25),
        (4, -40.0, 0.001),
        (5, 0.0, 99.99),
        (6, 3.14159, 2.71828),
        (7, 1000000.5, 0.0001),
        (8, -273.15, 1.0)
    expect:
      affected_rows: 8

  - name: "Float: select before compression"
    sql: "SELECT temperature, ratio FROM st_float WHERE id = 1"
    expect:
      rows: 1
      data:
        - temperature: 98.6
          ratio: 0.5

  - name: "Float: NULL handling"
    sql: "INSERT INTO st_float VALUES (9, NULL, NULL)"
    expect:
      affected_rows: 1

  - name: "Float: verify NULL"
    sql: "SELECT temperature, ratio FROM st_float WHERE id = 9"
    expect:
      rows: 1
      data:
        - temperature: null
          ratio: null

  # === StorageInt: columns with only integer values (non-sequential) ===
  - name: "Create int table"
    sql: "CREATE TABLE st_int (id INT, score INT, flags INT)"
    expect:
      rows: 0

  - name: "Insert integer data (non-sequential for StorageInt)"
    sql: |
      INSERT INTO st_int VALUES
        (1, 100, 7),
        (2, 500, 3),
        (3, 42, 15),
        (4, 9999, 1),
        (5, -50, 0),
        (6, 0, 255),
        (7, 1000000, 128),
        (8, -1000000, 64)
    expect:
      affected_rows: 8

  - name: "Int: select before compression"
    sql: "SELECT score, flags FROM st_int WHERE id = 3"
    expect:
      rows: 1
      data:
        - score: 42
          flags: 15

  - name: "Int: NULL handling"
    sql: "INSERT INTO st_int VALUES (9, NULL, NULL)"
    expect:
      affected_rows: 1

  - name: "Int: verify NULL"
    sql: "SELECT score FROM st_int WHERE id = 9"
    expect:
      rows: 1
      data:
        - score: null

  # === StorageSeq: sequential/arithmetic progression ===
  - name: "Create sequence table"
    sql: "CREATE TABLE st_seq (id INT PRIMARY KEY AUTO_INCREMENT, label VARCHAR(20))"
    expect:
      rows: 0

  - name: "Insert sequential data (AUTO_INCREMENT triggers StorageSeq)"
    sql: |
      INSERT INTO st_seq (label) VALUES
        ('a'), ('b'), ('c'), ('d'), ('e'),
        ('f'), ('g'), ('h'), ('i'), ('j')
    expect:
      affected_rows: 10

  - name: "Seq: verify auto-increment ids"
    sql: "SELECT id, label FROM st_seq WHERE id <= 3 ORDER BY id"
    expect:
      rows: 3
      data:
        - id: 1
          label: "a"
        - id: 2
          label: "b"
        - id: 3
          label: "c"

  - name: "Seq: count all"
    sql: "SELECT COUNT(*) AS cnt FROM st_seq"
    expect:
      rows: 1
      data:
        - cnt: 10

  # === StorageString: dictionary-compressed strings ===
  - name: "Create string table"
    sql: "CREATE TABLE st_string (id INT, category VARCHAR(30), tag VARCHAR(20))"
    expect:
      rows: 0

  - name: "Insert string data (low cardinality for dictionary mode)"
    sql: |
      INSERT INTO st_string VALUES
        (1, 'electronics', 'sale'),
        (2, 'clothing', 'new'),
        (3, 'electronics', 'sale'),
        (4, 'books', 'clearance'),
        (5, 'clothing', 'sale'),
        (6, 'electronics', 'new'),
        (7, 'books', 'sale'),
        (8, 'clothing', 'clearance')
    expect:
      affected_rows: 8

  - name: "String: query with filter"
    sql: "SELECT id, category FROM st_string WHERE tag = 'sale' ORDER BY id"
    expect:
      rows: 4
      data:
        - id: 1
          category: "electronics"
        - id: 3
          category: "electronics"
        - id: 5
          category: "clothing"
        - id: 7
          category: "books"

  - name: "String: NULL handling"
    sql: "INSERT INTO st_string VALUES (9, NULL, NULL)"
    expect:
      affected_rows: 1

  - name: "String: verify NULL"
    sql: "SELECT category, tag FROM st_string WHERE id = 9"
    expect:
      rows: 1
      data:
        - category: null
          tag: null

  # === StorageSCMER: mixed types that can't compress ===
  - name: "Create mixed table"
    sql: "CREATE TABLE st_mixed (id INT, data TEXT)"
    expect:
      rows: 0

  - name: "Insert mixed data"
    sql: |
      INSERT INTO st_mixed VALUES
        (1, 'text value'),
        (2, '42'),
        (3, 'true'),
        (4, NULL),
        (5, '{"key":"val"}'),
        (6, 'another string'),
        (7, ''),
        (8, 'final')
    expect:
      affected_rows: 8

  # === StorageSeq edge cases: NULLs at start, multiple strides, gaps ===
  - name: "Create seq edge table"
    sql: "CREATE TABLE st_seq_edge (pos INT, val INT)"
    expect:
      rows: 0

  - name: "Insert seq edge data: NULLs, gaps, multiple strides"
    sql: |
      INSERT INTO st_seq_edge VALUES
        (0, NULL), (1, NULL),
        (2, 3), (3, 4), (4, 5), (5, 6), (6, 7), (7, 8), (8, 9),
        (9, NULL),
        (10, 10), (11, 20), (12, 30), (13, 40), (14, 50), (15, 60)
    expect:
      affected_rows: 16

  - name: "SeqEdge: verify before compression"
    sql: "SELECT val FROM st_seq_edge WHERE pos = 5"
    expect:
      rows: 1
      data:
        - val: 6

  # === StorageString buffer mode: >100 unique strings triggers nodict ===
  - name: "Create string buffer table"
    sql: "CREATE TABLE st_str_buf (id INT, data VARCHAR(20))"
    expect:
      rows: 0

  - name: "Insert 60 unique strings batch 1"
    sql: |
      INSERT INTO st_str_buf VALUES
        (1,'v1'),(2,'v2'),(3,'v3'),(4,'v4'),(5,'v5'),(6,'v6'),(7,'v7'),(8,'v8'),(9,'v9'),(10,'v10'),
        (11,'v11'),(12,'v12'),(13,'v13'),(14,'v14'),(15,'v15'),(16,'v16'),(17,'v17'),(18,'v18'),(19,'v19'),(20,'v20'),
        (21,'v21'),(22,'v22'),(23,'v23'),(24,'v24'),(25,'v25'),(26,'v26'),(27,'v27'),(28,'v28'),(29,'v29'),(30,'v30'),
        (31,'v31'),(32,'v32'),(33,'v33'),(34,'v34'),(35,'v35'),(36,'v36'),(37,'v37'),(38,'v38'),(39,'v39'),(40,'v40'),
        (41,'v41'),(42,'v42'),(43,'v43'),(44,'v44'),(45,'v45'),(46,'v46'),(47,'v47'),(48,'v48'),(49,'v49'),(50,'v50'),
        (51,'v51'),(52,'v52'),(53,'v53'),(54,'v54'),(55,'v55'),(56,'v56'),(57,'v57'),(58,'v58'),(59,'v59'),(60,'v60')
    expect:
      affected_rows: 60

  - name: "Insert 60 unique strings batch 2"
    sql: |
      INSERT INTO st_str_buf VALUES
        (61,'v61'),(62,'v62'),(63,'v63'),(64,'v64'),(65,'v65'),(66,'v66'),(67,'v67'),(68,'v68'),(69,'v69'),(70,'v70'),
        (71,'v71'),(72,'v72'),(73,'v73'),(74,'v74'),(75,'v75'),(76,'v76'),(77,'v77'),(78,'v78'),(79,'v79'),(80,'v80'),
        (81,'v81'),(82,'v82'),(83,'v83'),(84,'v84'),(85,'v85'),(86,'v86'),(87,'v87'),(88,'v88'),(89,'v89'),(90,'v90'),
        (91,'v91'),(92,'v92'),(93,'v93'),(94,'v94'),(95,'v95'),(96,'v96'),(97,'v97'),(98,'v98'),(99,'v99'),(100,'v100'),
        (101,'v101'),(102,'v102'),(103,'v103'),(104,'v104'),(105,'v105'),(106,'v106'),(107,'v107'),(108,'v108'),(109,'v109'),(110,'v110'),
        (111,'v111'),(112,'v112'),(113,'v113'),(114,'v114'),(115,'v115'),(116,'v116'),(117,'v117'),(118,'v118'),(119,'v119'),(120,'v120')
    expect:
      affected_rows: 60

  - name: "Insert NULL into string buffer"
    sql: "INSERT INTO st_str_buf VALUES (121, NULL)"
    expect:
      affected_rows: 1

  - name: "StrBuf: verify before compression"
    sql: "SELECT data FROM st_str_buf WHERE id = 50"
    expect:
      rows: 1
      data:
        - data: "v50"

  # === SHUTDOWN to force compression cycle ===
  - name: "SHUTDOWN to trigger compression"
    sql: "SHUTDOWN"
    expect:
      rows: 0

  # === Post-compression verification (after restart) ===

  # StorageFloat: verify after compression
  - name: "Float: post-compression select"
    sql: "SELECT temperature, ratio FROM st_float WHERE id = 1"
    expect:
      rows: 1
      data:
        - temperature: 98.6
          ratio: 0.5

  - name: "Float: negative values after compression"
    sql: "SELECT temperature FROM st_float WHERE id = 4"
    expect:
      rows: 1
      data:
        - temperature: -40

  - name: "Float: NULL after compression"
    sql: "SELECT temperature FROM st_float WHERE id = 9"
    expect:
      rows: 1
      data:
        - temperature: null

  - name: "Float: count all after compression"
    sql: "SELECT COUNT(*) AS cnt FROM st_float"
    expect:
      rows: 1
      data:
        - cnt: 9

  - name: "Float: aggregate after compression"
    sql: "SELECT MIN(temperature) AS mn, MAX(temperature) AS mx FROM st_float"
    expect:
      rows: 1
      data:
        - mn: -273.15
          mx: 1000000.5

  # StorageInt: verify after compression
  - name: "Int: post-compression select"
    sql: "SELECT score, flags FROM st_int WHERE id = 3"
    expect:
      rows: 1
      data:
        - score: 42
          flags: 15

  - name: "Int: negative after compression"
    sql: "SELECT score FROM st_int WHERE id = 8"
    expect:
      rows: 1
      data:
        - score: -1000000

  - name: "Int: NULL after compression"
    sql: "SELECT score FROM st_int WHERE id = 9"
    expect:
      rows: 1
      data:
        - score: null

  - name: "Int: aggregate after compression"
    sql: "SELECT MIN(score) AS mn, MAX(score) AS mx FROM st_int"
    expect:
      rows: 1
      data:
        - mn: -1000000
          mx: 1000000

  # StorageSeq: verify after compression
  - name: "Seq: post-compression sequential ids"
    sql: "SELECT id, label FROM st_seq WHERE id <= 3 ORDER BY id"
    expect:
      rows: 3
      data:
        - id: 1
          label: "a"
        - id: 2
          label: "b"
        - id: 3
          label: "c"

  - name: "Seq: last value"
    sql: "SELECT id, label FROM st_seq WHERE id = 10"
    expect:
      rows: 1
      data:
        - id: 10
          label: "j"

  - name: "Seq: count after compression"
    sql: "SELECT COUNT(*) AS cnt FROM st_seq"
    expect:
      rows: 1
      data:
        - cnt: 10

  # StorageString: verify after compression
  - name: "String: post-compression query"
    sql: "SELECT category FROM st_string WHERE id = 1"
    expect:
      rows: 1
      data:
        - category: "electronics"

  - name: "String: filter after compression"
    sql: "SELECT COUNT(*) AS cnt FROM st_string WHERE category = 'electronics'"
    expect:
      rows: 1
      data:
        - cnt: 3

  - name: "String: NULL after compression"
    sql: "SELECT category FROM st_string WHERE id = 9"
    expect:
      rows: 1
      data:
        - category: null

  # StorageSCMER/mixed: verify after compression
  - name: "Mixed: post-compression select"
    sql: "SELECT data FROM st_mixed WHERE id = 5"
    expect:
      rows: 1
      data:
        - data: "{\"key\":\"val\"}"

  - name: "Mixed: count after compression"
    sql: "SELECT COUNT(*) AS cnt FROM st_mixed"
    expect:
      rows: 1
      data:
        - cnt: 8

  # StorageSeq edge: verify after compression
  - name: "SeqEdge: NULL at start after compression"
    sql: "SELECT val FROM st_seq_edge WHERE pos = 0"
    expect:
      rows: 1
      data:
        - val: null

  - name: "SeqEdge: stride-1 value after compression"
    sql: "SELECT val FROM st_seq_edge WHERE pos = 5"
    expect:
      rows: 1
      data:
        - val: 6

  - name: "SeqEdge: mid-NULL after compression"
    sql: "SELECT val FROM st_seq_edge WHERE pos = 9"
    expect:
      rows: 1
      data:
        - val: null

  - name: "SeqEdge: stride-10 value after compression"
    sql: "SELECT val FROM st_seq_edge WHERE pos = 12"
    expect:
      rows: 1
      data:
        - val: 30

  - name: "SeqEdge: count after compression"
    sql: "SELECT COUNT(*) AS cnt FROM st_seq_edge"
    expect:
      rows: 1
      data:
        - cnt: 16

  # StorageString buffer: verify after compression
  - name: "StrBuf: read value after compression (nodict)"
    sql: "SELECT data FROM st_str_buf WHERE id = 1"
    expect:
      rows: 1
      data:
        - data: "v1"

  - name: "StrBuf: read high-id value after compression"
    sql: "SELECT data FROM st_str_buf WHERE id = 120"
    expect:
      rows: 1
      data:
        - data: "v120"

  - name: "StrBuf: NULL after compression (nodict)"
    sql: "SELECT data FROM st_str_buf WHERE id = 121"
    expect:
      rows: 1
      data:
        - data: null

  - name: "StrBuf: count after compression"
    sql: "SELECT COUNT(*) AS cnt FROM st_str_buf"
    expect:
      rows: 1
      data:
        - cnt: 121

  # === Second SHUTDOWN to test serialization of compressed storage ===
  - name: "Second SHUTDOWN to test persistence of compressed storage"
    sql: "SHUTDOWN"
    expect:
      rows: 0

  # === Post-persistence verification ===
  - name: "Float: after persistence roundtrip"
    sql: "SELECT temperature FROM st_float WHERE id = 6"
    expect:
      rows: 1
      data:
        - temperature: 3.14159

  - name: "Int: after persistence roundtrip"
    sql: "SELECT score FROM st_int WHERE id = 4"
    expect:
      rows: 1
      data:
        - score: 9999

  - name: "Seq: after persistence roundtrip"
    sql: "SELECT id, label FROM st_seq WHERE id = 5"
    expect:
      rows: 1
      data:
        - id: 5
          label: "e"

  - name: "String: after persistence roundtrip"
    sql: "SELECT tag FROM st_string WHERE id = 4"
    expect:
      rows: 1
      data:
        - tag: "clearance"

  - name: "Mixed: after persistence roundtrip"
    sql: "SELECT data FROM st_mixed WHERE id = 1"
    expect:
      rows: 1
      data:
        - data: "text value"

  - name: "SeqEdge: after persistence roundtrip"
    sql: "SELECT val FROM st_seq_edge WHERE pos = 14"
    expect:
      rows: 1
      data:
        - val: 50

  - name: "StrBuf: after persistence roundtrip"
    sql: "SELECT data FROM st_str_buf WHERE id = 75"
    expect:
      rows: 1
      data:
        - data: "v75"

  # === DML on compressed storage ===
  - name: "Float: UPDATE compressed value"
    sql: "UPDATE st_float SET temperature = 42.42 WHERE id = 1"
    expect:
      affected_rows: 1

  - name: "Float: verify UPDATE"
    sql: "SELECT temperature FROM st_float WHERE id = 1"
    expect:
      rows: 1
      data:
        - temperature: 42.42

  - name: "Int: DELETE from compressed"
    sql: "DELETE FROM st_int WHERE id = 8"
    expect:
      affected_rows: 1

  - name: "Int: verify DELETE"
    sql: "SELECT COUNT(*) AS cnt FROM st_int"
    expect:
      rows: 1
      data:
        - cnt: 8

  - name: "String: INSERT into compressed"
    sql: "INSERT INTO st_string VALUES (10, 'toys', 'new')"
    expect:
      affected_rows: 1

  - name: "String: verify INSERT"
    sql: "SELECT category FROM st_string WHERE id = 10"
    expect:
      rows: 1
      data:
        - category: "toys"

  - name: "Seq: INSERT into auto_increment after compression"
    sql: "INSERT INTO st_seq (label) VALUES ('k')"
    expect:
      affected_rows: 1

  - name: "Seq: verify auto_increment continues"
    sql: "SELECT id, label FROM st_seq WHERE label = 'k'"
    expect:
      rows: 1
      data:
        - id: 11
          label: "k"

cleanup:
  - sql: "DROP TABLE IF EXISTS st_float"
  - sql: "DROP TABLE IF EXISTS st_int"
  - sql: "DROP TABLE IF EXISTS st_seq"
  - sql: "DROP TABLE IF EXISTS st_string"
  - sql: "DROP TABLE IF EXISTS st_mixed"
  - sql: "DROP TABLE IF EXISTS st_seq_edge"
  - sql: "DROP TABLE IF EXISTS st_str_buf"
