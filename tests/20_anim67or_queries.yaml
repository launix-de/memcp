# SQL queries from anim67or application
# Tests for various SQL features used in the application
#
# Known missing features (marked noncritical):
# - EXISTS subqueries
# - BETWEEN operator
# - NOT IN clause
# - IN with subquery
# - Scalar subqueries return null instead of 0 for empty results

metadata:
  version: "1.0"
  description: "SQL features from anim67or application"

setup:
  # Files table for EXISTS subquery tests
  - sql: "DROP TABLE IF EXISTS fop_files"
  - sql: "DROP TABLE IF EXISTS renderjob"
  - sql: "DROP TABLE IF EXISTS scene"
  - sql: "DROP TABLE IF EXISTS project"
  - sql: "DROP TABLE IF EXISTS asset"
  - sql: "DROP TABLE IF EXISTS assetCollection"
  - sql: "DROP TABLE IF EXISTS items"
  - sql: "DROP TABLE IF EXISTS cron"
  - sql: "DROP TABLE IF EXISTS fop_idlistitem"
  - sql: |
      CREATE TABLE fop_files (
        ID INT PRIMARY KEY,
        filename VARCHAR(255),
        type VARCHAR(64),
        size INT,
        hash VARCHAR(64),
        lastUsed INT
      )
  - sql: |
      CREATE TABLE renderjob (
        ID INT PRIMARY KEY,
        result INT
      )
  - sql: |
      CREATE TABLE scene (
        ID INT PRIMARY KEY,
        img INT,
        project INT
      )
  - sql: |
      CREATE TABLE project (
        ID INT PRIMARY KEY,
        creator INT
      )
  - sql: |
      CREATE TABLE asset (
        ID INT PRIMARY KEY,
        media INT,
        collection INT
      )
  - sql: |
      CREATE TABLE assetCollection (
        ID INT PRIMARY KEY,
        public BOOLEAN,
        creator INT
      )
  - sql: |
      CREATE TABLE items (
        ID INT PRIMARY KEY,
        name VARCHAR(64),
        code VARCHAR(32)
      )
  - sql: |
      CREATE TABLE cron (
        name VARCHAR(64) PRIMARY KEY,
        lastrun INT,
        medianruntime DOUBLE
      )
  - sql: |
      CREATE TABLE fop_idlistitem (
        list INT,
        item INT
      )
  # Insert test data
  - sql: |
      INSERT INTO fop_files (ID, filename, type, size, hash, lastUsed) VALUES
      (1, 'image1.png', 'image/png', 1024, 'abc123', 1700000000),
      (2, 'doc.pdf', 'application/pdf', 2048, 'def456', 1700000100),
      (3, 'audio.mp3', 'audio/mpeg', 4096, 'ghi789', 1700000200)
  - sql: |
      INSERT INTO renderjob (ID, result) VALUES
      (1, 1),
      (2, 1)
  - sql: |
      INSERT INTO scene (ID, img, project) VALUES
      (1, 2, 1),
      (2, 3, 2)
  - sql: |
      INSERT INTO project (ID, creator) VALUES
      (1, 100),
      (2, 200)
  - sql: |
      INSERT INTO asset (ID, media, collection) VALUES
      (1, 1, 1),
      (2, 2, 2)
  - sql: |
      INSERT INTO assetCollection (ID, public, creator) VALUES
      (1, true, 100),
      (2, false, 200)
  - sql: |
      INSERT INTO items (ID, name, code) VALUES
      (1, 'Item One', 'CODE001'),
      (2, 'Item Two', 'CODE002'),
      (3, 'Item Three', 'CODE003'),
      (4, 'Item Four', 'CODE100'),
      (5, 'Item Five', 'CODE999')
  - sql: |
      INSERT INTO cron (name, lastrun, medianruntime) VALUES
      ('job1', 1700000000, 1.5),
      ('job2', 1700000100, 2.0)
  - sql: |
      INSERT INTO fop_idlistitem (list, item) VALUES
      (1, 10), (1, 20), (1, 30),
      (2, 100), (2, 200)

test_cases:
  # EXISTS subquery tests (noncritical - not yet supported)
  - name: "EXISTS with simple subquery"
    noncritical: true
    sql: |
      SELECT ID, filename
      FROM fop_files
      WHERE EXISTS (SELECT ID FROM renderjob WHERE result = fop_files.ID)
    expect:
      rows: 1
      data:
        - ID: 1
          filename: "image1.png"

  - name: "EXISTS with UNION ALL subquery"
    noncritical: true
    sql: |
      SELECT ID, filename
      FROM fop_files
      WHERE EXISTS (
        SELECT ID FROM renderjob WHERE result = fop_files.ID
        UNION ALL
        SELECT ID FROM scene WHERE img = fop_files.ID
      )
      ORDER BY ID
    expect:
      rows: 3
      data:
        - ID: 1
          filename: "image1.png"
        - ID: 2
          filename: "doc.pdf"
        - ID: 3
          filename: "audio.mp3"

  - name: "NOT EXISTS subquery"
    noncritical: true
    sql: |
      SELECT ID, filename
      FROM fop_files
      WHERE NOT EXISTS (SELECT ID FROM renderjob WHERE result = fop_files.ID)
      ORDER BY ID
    expect:
      rows: 2
      data:
        - ID: 2
          filename: "doc.pdf"
        - ID: 3
          filename: "audio.mp3"

  # Boolean literal tests (TRUE/FALSE AS column)
  - name: "Boolean TRUE literal as column"
    sql: |
      SELECT ID, TRUE AS is_active FROM fop_files WHERE ID = 1
    expect:
      rows: 1
      data:
        - ID: 1
          is_active: 1

  - name: "Boolean FALSE literal as column"
    sql: |
      SELECT ID, FALSE AS is_deleted FROM fop_files WHERE ID = 1
    expect:
      rows: 1
      data:
        - ID: 1
          is_deleted: 0

  - name: "NULL literal as column"
    sql: |
      SELECT ID, NULL AS optional_field FROM fop_files WHERE ID = 1
    expect:
      rows: 1
      data:
        - ID: 1
          optional_field: null

  - name: "Mixed boolean and NULL literals"
    sql: |
      SELECT
        TRUE AS admin,
        FALSE AS isGuest,
        NULL AS username
    expect:
      rows: 1
      data:
        - admin: 1
          isGuest: 0
          username: null

  # COALESCE tests
  - name: "COALESCE with NULL"
    sql: |
      SELECT COALESCE(NULL, 'default') AS result
    expect:
      rows: 1
      data:
        - result: "default"

  - name: "COALESCE with multiple values"
    sql: |
      SELECT COALESCE(NULL, NULL, 'third') AS result
    expect:
      rows: 1
      data:
        - result: "third"

  - name: "COALESCE with non-NULL first value"
    sql: |
      SELECT COALESCE('first', 'second') AS result
    expect:
      rows: 1
      data:
        - result: "first"

  # CASE WHEN tests
  - name: "CASE WHEN simple"
    sql: |
      SELECT ID,
        CASE WHEN type = 'image/png' THEN 'image'
             WHEN type = 'application/pdf' THEN 'document'
             ELSE 'other'
        END AS category
      FROM fop_files
      ORDER BY ID
    expect:
      rows: 3
      data:
        - ID: 1
          category: "image"
        - ID: 2
          category: "document"
        - ID: 3
          category: "other"

  - name: "CASE WHEN with boolean result"
    sql: |
      SELECT ID,
        CASE WHEN size > 2000 THEN TRUE ELSE FALSE END AS is_large
      FROM fop_files
      ORDER BY ID
    expect:
      rows: 3
      data:
        - ID: 1
          is_large: 0
        - ID: 2
          is_large: 1
        - ID: 3
          is_large: 1

  # BETWEEN tests (noncritical - not yet supported)
  - name: "BETWEEN numeric range"
    noncritical: true
    sql: |
      SELECT ID, size FROM fop_files WHERE size BETWEEN 1000 AND 3000 ORDER BY ID
    expect:
      rows: 2
      data:
        - ID: 1
          size: 1024
        - ID: 2
          size: 2048

  - name: "NOT BETWEEN"
    noncritical: true
    sql: |
      SELECT ID, size FROM fop_files WHERE size NOT BETWEEN 1000 AND 3000 ORDER BY ID
    expect:
      rows: 1
      data:
        - ID: 3
          size: 4096

  # IN clause tests
  - name: "IN with literal list"
    sql: |
      SELECT ID, filename FROM fop_files WHERE ID IN (1, 3) ORDER BY ID
    expect:
      rows: 2
      data:
        - ID: 1
          filename: "image1.png"
        - ID: 3
          filename: "audio.mp3"

  - name: "NOT IN with literal list"
    noncritical: true
    sql: |
      SELECT ID, filename FROM fop_files WHERE ID NOT IN (1, 3) ORDER BY ID
    expect:
      rows: 1
      data:
        - ID: 2
          filename: "doc.pdf"

  - name: "IN with subquery"
    noncritical: true
    sql: |
      SELECT ID, filename FROM fop_files
      WHERE ID IN (SELECT result FROM renderjob)
      ORDER BY ID
    expect:
      rows: 1
      data:
        - ID: 1
          filename: "image1.png"

  # COUNT tests
  - name: "COUNT(*)"
    sql: |
      SELECT COUNT(*) AS cnt FROM fop_files
    expect:
      rows: 1
      data:
        - cnt: 3

  - name: "COUNT with alias"
    sql: |
      SELECT COUNT(*) AS total_files FROM fop_files WHERE size > 1000
    expect:
      rows: 1
      data:
        - total_files: 3

  # Arithmetic in UPDATE (test via SELECT)
  - name: "Arithmetic expressions"
    sql: |
      SELECT name, COALESCE(0.9 * medianruntime + 0.1 * 3.0, 3.0) AS new_runtime
      FROM cron
      WHERE name = 'job1'
    expect:
      rows: 1
      data:
        - name: "job1"
          new_runtime: 1.65

  # LIKE with wildcards
  - name: "LIKE with percent wildcard"
    sql: |
      SELECT ID, code FROM items WHERE code LIKE 'CODE0%' ORDER BY ID
    expect:
      rows: 3
      data:
        - ID: 1
          code: "CODE001"
        - ID: 2
          code: "CODE002"
        - ID: 3
          code: "CODE003"

  - name: "LIKE with underscore wildcard"
    sql: |
      SELECT ID, code FROM items WHERE code LIKE 'CODE00_' ORDER BY ID
    expect:
      rows: 3
      data:
        - ID: 1
          code: "CODE001"
        - ID: 2
          code: "CODE002"
        - ID: 3
          code: "CODE003"

  # Scalar subquery in SELECT - returns null for empty results (use COALESCE)
  - name: "Scalar subquery in SELECT"
    noncritical: true
    sql: |
      SELECT ID, filename,
        (SELECT COUNT(*) FROM renderjob WHERE result = fop_files.ID) AS job_count
      FROM fop_files
      ORDER BY ID
    expect:
      rows: 3
      data:
        - ID: 1
          filename: "image1.png"
          job_count: 2
        - ID: 2
          filename: "doc.pdf"
          job_count: 0
        - ID: 3
          filename: "audio.mp3"
          job_count: 0

  # Workaround: use COALESCE for scalar subqueries that may return null
  - name: "Scalar subquery with COALESCE workaround"
    sql: |
      SELECT ID, filename,
        COALESCE((SELECT COUNT(*) FROM renderjob WHERE result = fop_files.ID), 0) AS job_count
      FROM fop_files
      ORDER BY ID
    expect:
      rows: 3
      data:
        - ID: 1
          filename: "image1.png"
          job_count: 2
        - ID: 2
          filename: "doc.pdf"
          job_count: 0
        - ID: 3
          filename: "audio.mp3"
          job_count: 0

  # COALESCE with scalar subquery
  - name: "COALESCE with scalar subquery"
    sql: |
      SELECT ID,
        COALESCE((SELECT creator FROM project WHERE project.ID = scene.project LIMIT 1), 0) AS creator_id
      FROM scene
      ORDER BY ID
    expect:
      rows: 2
      data:
        - ID: 1
          creator_id: 100
        - ID: 2
          creator_id: 200

  # Complex EXISTS with correlated subquery (noncritical - EXISTS not yet supported)
  - name: "EXISTS with correlated subquery joining multiple tables"
    noncritical: true
    sql: |
      SELECT f.ID, f.filename
      FROM fop_files f
      WHERE EXISTS (
        SELECT 1 FROM asset a
        WHERE a.media = f.ID
        AND EXISTS (
          SELECT 1 FROM assetCollection ac
          WHERE ac.ID = a.collection AND ac.public = true
        )
      )
    expect:
      rows: 1
      data:
        - ID: 1
          filename: "image1.png"

  # SELECT with multiple boolean conditions
  - name: "Complex boolean expression"
    sql: |
      SELECT ID, filename
      FROM fop_files
      WHERE (type = 'image/png' OR type = 'application/pdf')
        AND size > 500
        AND NOT (hash = 'invalid')
      ORDER BY ID
    expect:
      rows: 2
      data:
        - ID: 1
          filename: "image1.png"
        - ID: 2
          filename: "doc.pdf"

  # IS NULL / IS NOT NULL
  - name: "IS NULL check"
    sql: |
      SELECT ID FROM fop_files WHERE lastUsed IS NOT NULL ORDER BY ID
    expect:
      rows: 3
      data:
        - ID: 1
        - ID: 2
        - ID: 3

  # Comparison operators
  - name: "Not equal operator <>"
    sql: |
      SELECT ID, filename FROM fop_files WHERE type <> 'image/png' ORDER BY ID
    expect:
      rows: 2
      data:
        - ID: 2
          filename: "doc.pdf"
        - ID: 3
          filename: "audio.mp3"

cleanup:
  - sql: "DROP TABLE IF EXISTS fop_files"
  - sql: "DROP TABLE IF EXISTS renderjob"
  - sql: "DROP TABLE IF EXISTS scene"
  - sql: "DROP TABLE IF EXISTS project"
  - sql: "DROP TABLE IF EXISTS asset"
  - sql: "DROP TABLE IF EXISTS assetCollection"
  - sql: "DROP TABLE IF EXISTS items"
  - sql: "DROP TABLE IF EXISTS cron"
  - sql: "DROP TABLE IF EXISTS fop_idlistitem"
